<!DOCTYPE html>
<html lang="en-IN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raygaon Voter Management</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Syne:wght@500;600&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="login-active">
  <div class="app-shell">
    <header class="app-header">
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
      </button>
      <div class="title"
        style="position: absolute; left: 50%; transform: translateX(-50%); text-align: center; line-height: 1.2; display: flex; flex-direction: column; align-items: center; width: max-content;">
        <div style="font-size: 1.4rem;">RAYGAON VOTER MANAGEMENT</div>
        <div style="font-size: 1rem; font-weight: 500;">रायगाव मतदार व्यवस्थापन</div>
      </div>
      <div class="meta">
        <select id="langSelect" class="lang-selector">
          <option value="en">English</option>
          <option value="mr">मराठी</option>
        </select>
        <button class="signout-btn" id="signOutBtn" style="display:none;">
          <i class="fas fa-sign-out-alt"></i> <span data-translate="sign_out">Sign Out</span>
        </button>
      </div>

    </header>

    <main class="main-area">
      <section id="landingSection">
        <button class="primary" id="showLoginBtn">Login</button>
      </section>
      <section id="authSection" style="display: none;">
        <article class="auth-card">
          <button class="auth-card-close" id="closeAuthBtn" type="button">
            <i class="fas fa-times"></i>
          </button>
          <div class="role-toggle">
            <button class="role-button active" type="button" data-role-tab="admin">Admin</button>
            <button class="role-button" type="button" data-role-tab="user">User</button>
          </div>

          <div class="login-variant active" id="adminLoginBlock">
            <h2>Admin Login</h2>
            <form id="adminLoginForm">
              <div>
                <label for="adminEmail">Official Email</label>
                <input type="email" id="adminEmail" placeholder="Enter official email" required />
              </div>
              <div>
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" placeholder="••••••••" required />
              </div>
              <button class="primary" type="submit"
                style="width: 100%; margin-top: 1.25rem; margin-bottom: 0.75rem;">Admin Login</button>
              <small id="adminStatus" aria-live="polite"
                style="color: var(--danger);display:block;margin-top:0.4rem;text-align:center;"></small>
            </form>
          </div>

          <div class="login-variant" id="userLoginBlock">
            <h2>User Login</h2>
            <p style="color: var(--text-muted); text-align: center; margin-bottom: 1.5rem; font-size: 0.9rem;">
              Secure access required. Please sign in using your Google account to enter the dashboard.
            </p>
            <button class="primary" type="button" id="googleSignIn"
              style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem; padding: 0.8rem;">
              <i class="fab fa-google"></i> Sign in with Google
            </button>
          </div>
        </article>
      </section>

      <section id="dashboard">
        <aside class="sidebar">
          <div class="nav-group">
            <button class="nav-button active" data-target="overviewSection">
              <i class="fas fa-tachometer-alt"></i> <span data-translate="nav_overview">Overview</span>
            </button>
            <button class="nav-button" data-target="searchVoterSection">
              <i class="fas fa-search"></i> <span data-translate="nav_search">Search Voter</span>
            </button>
            <button class="nav-button" data-target="addVoterSection" data-requires-admin="true">
              <i class="fas fa-user-plus"></i> <span data-translate="nav_add_voter">Add Voter</span>
            </button>
            <button class="nav-button" data-target="directorySection">
              <i class="fas fa-address-book"></i> <span data-translate="nav_directory">Voter Directory</span>
            </button>
            <button class="nav-button" data-target="deceasedListSection" data-requires-admin="true">
              <i class="fas fa-user-times"></i> <span data-translate="nav_deceased_list">Deceased List</span>
            </button>
            <button class="nav-button" data-target="votedListSection" data-requires-admin="true">
              <i class="fas fa-check-circle"></i> <span data-translate="nav_voted_list">Voted List</span>
            </button>
            <button class="nav-button" data-target="staffSection" data-requires-admin="true">
              <i class="fas fa-chalkboard-teacher"></i> <span data-translate="nav_staff_info">Staff Info</span>
            </button>
            <button class="nav-button" data-target="staffDirectorySection">
              <i class="fas fa-users"></i> <span data-translate="nav_staff_directory">Staff Directory</span>
            </button>
            <button class="nav-button" data-target="familyManagementSection">
              <i class="fas fa-home"></i> <span data-translate="nav_family_management">Family Management</span>
            </button>
            <button class="nav-button" data-target="analyticsSection">
              <i class="fas fa-chart-pie"></i> <span data-translate="nav_analytics">Analytics</span>
            </button>
            <button class="nav-button" data-target="duplicateListSection">
              <i class="fas fa-users-slash"></i> <span data-translate="nav_duplicate_list">Duplicate Voter List</span>
            </button>
            <button class="nav-button" data-target="userLoginsSection" data-requires-admin="true">
              <i class="fas fa-user-shield"></i> <span data-translate="nav_user_logins">User Logins</span>
            </button>
            <button class="nav-button" data-target="manageAdminSection" data-requires-admin="true">
              <i class="fas fa-user-cog"></i> <span data-translate="nav_manage_admin">Manage Admin</span>
            </button>
          </div>
        </aside>
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <div>
          <section id="overviewSection" class="panel active">
            <h2 data-translate="dash_overview">Dashboard Overview</h2>
            <p id="welcomeText">Welcome.</p>
            <div class="stat-grid" id="mainStatsGrid">
              <div class="stat-card" data-type="total">
                <i class="fas fa-users stat-icon"></i>
                <h3 data-translate="total_voters">Total Registered</h3>
                <div class="value-container">
                  <p id="totalVoters">0</p>
                </div>
              </div>
              <div class="stat-card" data-type="female">
                <i class="fas fa-venus stat-icon"></i>
                <h3 data-translate="female_voters">Female Voters</h3>
                <div class="value-container">
                  <p id="femaleVoters">0</p>
                </div>
              </div>
              <div class="stat-card" data-type="male">
                <i class="fas fa-mars stat-icon"></i>
                <h3 data-translate="male_voters">Male Voters</h3>
                <div class="value-container">
                  <p id="maleVoters">0</p>
                </div>
              </div>
              <div class="stat-card" data-type="total">
                <i class="fas fa-user-tie stat-icon"></i>
                <h3 data-translate="staff_count">Staff Records</h3>
                <div class="value-container">
                  <p id="staffCount">0</p>
                </div>
              </div>
              <div class="stat-card" data-type="voted">
                <i class="fas fa-check-circle stat-icon"></i>
                <h3 data-translate="voted_status">Total Voted</h3>
                <div class="value-container">
                  <p id="votedSummaryCount">0</p>
                </div>
                <div class="percent-badge" id="totalVotingPercent">0%</div>
              </div>
            </div>

            <div id="boothStatsGrid" class="stat-grid" style="margin-top: 1.5rem;">
              <!-- Booth cards will be injected here -->
            </div>
          </section>

          <section id="directorySection" class="panel" style="margin-top: 0 !important; padding-top: 1rem;">
            <h2 data-translate="voter_directory_title">Voter Directory</h2>
            <div class="import-toolbar"
              style="margin-bottom:0.5rem; display: flex; align-items: center; justify-content: space-between;">
              <div style="flex: 1; text-align: center;">
                <p style="margin:0;color:var(--muted);font-size:0.9rem;" data-translate="filter_voters_desc">Filter
                  voters by district, taluka, caste,
                  gender, or voter type and export to Excel.</p>
              </div>
              <button type="button" class="download-btn" id="bulkTransliterateBtn"
                style="margin-right:0.5rem; display:none;" data-requires-admin="true">
                <i class="fas fa-sync-alt"></i> Convert All to Marathi
              </button>
              <button type="button" class="export-btn" id="exportVoterDirectory">
                <i class="fas fa-file-excel"></i> <span data-translate="export_excel_btn">Export Excel</span>
              </button>
            </div>
            <div class="filters">
              <input type="text" id="searchText" data-translate-placeholder="search_placeholder"
                placeholder="Search name / EPIC" />
              <select id="filterDistrict">
                <option value="" data-translate="all_districts">All Districts</option>
              </select>
              <select id="filterTaluka">
                <option value="" data-translate="all_talukas">All Talukas</option>
              </select>
              <select id="filterBooth">
                <option value="" data-translate="all_booths">All Booths</option>
              </select>
              <select id="filterCaste">
                <option value="" data-translate="all_castes">All Castes</option>
              </select>
              <select id="filterGender">
                <option value="" data-translate="all_genders">All Genders</option>
                <option value="Female" data-translate="female_header">Female</option>
                <option value="Male" data-translate="male_header">Male</option>
                <option value="Other" data-translate="other_header">Other</option>
              </select>
              <select id="filterVoterType" data-requires-admin="true">
                <option value="" data-translate="all_types">All Types</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
              </select>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>List No.</th>
                    <th>Name</th>
                    <th>EPIC</th>
                    <th>Booth</th>
                    <th>District</th>
                    <th>Taluka</th>
                    <th>Caste</th>
                    <th>Gender</th>
                    <th>Mobile</th>
                    <th>Address</th>
                    <th data-requires-admin="true">Type</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="voterTableBody">
                  <tr>
                    <td colspan="11">No voter records found.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="addVoterSection" class="panel">
            <h2 data-translate="nav_add_voter">Add Voter</h2>
            <p data-translate="add_voter_desc">Enter voter information for any Maharashtra district. Taluka options
              refresh based on the selected
              district.</p>
            <div class="import-panel">
              <h4 data-translate="bulk_import_voters"><i class="fas fa-file-import"></i> Bulk Import Voters</h4>
              <p style="color: var(--text-muted); margin-top: 0.5rem;" data-translate="bulk_import_desc">Upload a CSV
                file to add multiple voters at once.</p>
              <div class="import-toolbar">
                <button type="button" class="download-btn" id="downloadVoterSample">
                  <i class="fas fa-file-download"></i> <span data-translate="download_sample_csv">Download Sample
                    CSV</span>
                </button>
                <label class="file-label">
                  <i class="fas fa-upload"></i> <span data-translate="import_csv">Import CSV</span>
                  <input type="file" id="importVoterCSV" accept=".csv" />
                </label>
                <small style="color: var(--text-muted);"><i class="fas fa-info-circle"></i> <span
                    data-translate="headers_match_template">Headers must match template.</span></small>
              </div>
              <div class="import-progress-container" id="voterProgressContainer">
                <div class="import-progress-bar" id="voterProgressBar"></div>
              </div>
              <div class="import-stats" id="voterImportStats">
                <span id="voterProgressPercent">0%</span>
                <span id="voterProgressCount">0 / 0</span>
              </div>
            </div>
            <form id="voterForm">
              <div class="grid-two">
                <div>
                  <label for="boothNo" data-translate="booth_no_label">Booth No.</label>
                  <select id="boothNo" required>
                    <option value="" data-translate="select_booth">Select booth</option>
                    <option value="2">Booth 2</option>
                    <option value="3">Booth 3</option>
                  </select>
                </div>
                <div>
                  <label for="listNo" data-translate="voter_list_no_label">Voter List No.</label>
                  <input type="text" id="listNo" required />
                </div>
                <div>
                  <label for="voterName" data-translate="voter_name_label">Voter Name (English)</label>
                  <input type="text" id="voterName" required />
                </div>
                <div>
                  <label for="voterNameMr" data-translate="voter_name_mr_label">Voter Name (Marathi)</label>
                  <input type="text" id="voterNameMr" required />
                </div>
                <div>
                  <label for="epicNo" data-translate="epic_no_label">EPIC No.</label>
                  <input type="text" id="epicNo" required />
                </div>
                <div>
                  <label for="mobileNo" data-translate="mobile_no_label">Mobile No.</label>
                  <input type="tel" id="mobileNo" pattern="[0-9]{10}" maxlength="10" required />
                </div>
                <div>
                  <label for="districtSelect" data-translate="district_label">District (Maharashtra)</label>
                  <select id="districtSelect" required></select>
                </div>
                <div>
                  <label for="talukaSelect" data-translate="taluka_label">Taluka</label>
                  <select id="talukaSelect" required></select>
                </div>
                <div>
                  <label for="genderSelect" data-translate="gender_label">Gender</label>
                  <select id="genderSelect" required>
                    <option value="" data-translate="select_gender">Select gender</option>
                    <option value="Female" data-translate="female_header">Female</option>
                    <option value="Male" data-translate="male_header">Male</option>
                    <option value="Other" data-translate="other_header">Other</option>
                  </select>
                </div>
                <div>
                  <label for="villageName" data-translate="village_label">Village</label>
                  <input type="text" id="villageName" value="Raygaon" required />
                </div>
                <div>
                  <label for="casteSelect" data-translate="caste_label">Caste</label>
                  <select id="casteSelect" required>
                    <option value="">Select Caste</option>
                  </select>
                </div>
                <div>
                  <label for="voterType" data-translate="voter_type_label">Voter Type</label>
                  <select id="voterType" required>
                    <option value="" data-translate="select_type">Select Type</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                  </select>
                </div>
                <div class="toggle-group" id="familyHeadToggleGroup">
                  <label for="isFamilyHead" data-translate="is_family_head">Is Family Head?</label>
                  <label class="switch">
                    <input type="checkbox" id="isFamilyHead" />
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
              <div>
                <label for="address" data-translate="address_label">Address</label>
                <textarea id="address" data-translate-placeholder="address_placeholder"
                  placeholder="House / Street / Landmark" required></textarea>
              </div>
              <button class="primary" type="submit" data-translate="save_voter_btn">Save Voter</button>
            </form>
          </section>

          <section id="staffSection" class="panel">
            <h2 data-translate="staff_info_title">Staff Information (Village: Raygaon)</h2>
            <div class="import-panel">
              <h4 data-translate="import_staff_data"><i class="fas fa-file-import"></i> Import Staff Data</h4>
              <p style="color: var(--text-muted); margin-top: 0.5rem;" data-translate="download_sample_sheet_desc">
                Download the sample sheet, fill it, and upload it back.</p>
              <div class="import-toolbar">
                <button type="button" class="download-btn" id="downloadStaffSample">
                  <i class="fas fa-file-download"></i> <span data-translate="download_sample_csv">Download Sample
                    CSV</span>
                </button>
                <label class="file-label">
                  <i class="fas fa-upload"></i> <span data-translate="import_csv">Import CSV</span>
                  <input type="file" id="importStaffCSV" accept=".csv" />
                </label>
                <small style="color: var(--text-muted);"><i class="fas fa-info-circle"></i> <span
                    data-translate="headers_match_template">Headers must match template.</span></small>
              </div>
              <div class="import-progress-container" id="staffProgressContainer">
                <div class="import-progress-bar" id="staffProgressBar"></div>
              </div>
              <div class="import-stats" id="staffImportStats">
                <span id="staffProgressPercent">0%</span>
                <span id="staffProgressCount">0 / 0</span>
              </div>
            </div>
            <form id="staffForm">
              <div class="grid-two">
                <div>
                  <label for="staffName" data-translate="staff_name_label">Name of Staff (EN)</label>
                  <input type="text" id="staffName" required />
                </div>
                <div>
                  <label for="staffNameMr" data-translate="staff_name_mr_label">Name of Staff (MR)</label>
                  <input type="text" id="staffNameMr" required />
                </div>
                <div>
                  <label for="staffBooth" data-translate="booth_no_label">Booth No.</label>
                  <select id="staffBooth" required>
                    <option value="" data-translate="select_booth">Select booth</option>
                    <option value="2">Booth 2</option>
                    <option value="3">Booth 3</option>
                  </select>
                </div>
                <div>
                  <label for="staffCaste" data-translate="staff_caste_label">Caste (EN)</label>
                  <select id="staffCaste" required>
                    <option value="">Select Caste</option>
                  </select>
                </div>
                <div>
                  <label for="staffCasteMr" data-translate="staff_caste_mr_label">Caste (MR)</label>
                  <input type="text" id="staffCasteMr" required />
                </div>
                <div>
                  <label for="staffDesignation" data-translate="staff_designation_label">Designation (EN)</label>
                  <input type="text" id="staffDesignation" required />
                </div>
                <div>
                  <label for="staffDesignationMr" data-translate="staff_designation_mr_label">Designation (MR)</label>
                  <input type="text" id="staffDesignationMr" required />
                </div>
                <div>
                  <label for="staffCollege" data-translate="staff_workplace_label">Working College / Office (EN)</label>
                  <input type="text" id="staffCollege" required />
                </div>
                <div>
                  <label for="staffCollegeMr" data-translate="staff_workplace_mr_label">Working College / Office
                    (MR)</label>
                  <input type="text" id="staffCollegeMr" required />
                </div>
                <div>
                  <label for="staffMobile" data-translate="mobile_no_label">Mobile No.</label>
                  <input type="tel" id="staffMobile" pattern="[0-9]{10}" maxlength="10" required />
                </div>
                <div>
                  <label for="staffHouseCount" data-translate="staff_house_count_label">Total Voters in House</label>
                  <input type="number" id="staffHouseCount" min="0" required />
                </div>
              </div>
              <button class="primary" type="submit" data-translate="save_staff_record_btn">Save Staff Record</button>
            </form>
          </section>

          <section id="staffDirectorySection" class="panel" style="margin-top: 0 !important; padding-top: 1rem;">
            <h2 data-translate="staff_directory_title">Raygaon Staff Directory</h2>
            <div class="import-toolbar"
              style="margin-bottom:0.5rem; display: flex; align-items: center; justify-content: space-between;">
              <div style="flex: 1; text-align: center;">
                <p style="margin:0;color:var(--muted);font-size:0.9rem;" data-translate="filter_staff_desc">Filter
                  Raygaon staff by booth and caste, then
                  export to Excel.</p>
              </div>
              <button type="button" class="download-btn" id="bulkTransliterateStaffBtn"
                style="margin-right:0.5rem; display:none;" data-requires-admin="true">
                <i class="fas fa-sync-alt"></i> Convert Staff to Marathi
              </button>
              <button type="button" class="export-btn" id="exportStaffDirectory">
                <i class="fas fa-file-excel"></i> <span data-translate="export_excel_btn">Export Excel</span>
              </button>
            </div>
            <div class="filters">
              <input type="text" id="staffSearchText" data-translate-placeholder="staff_search_placeholder"
                placeholder="Search staff by name" />
              <select id="staffFilterBooth">
                <option value="" data-translate="all_booths">All Booths</option>
              </select>
              <select id="staffFilterCaste">
                <option value="" data-translate="all_castes">All Castes</option>
              </select>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-translate="name_col">Name</th>
                    <th data-translate="booth">Booth</th>
                    <th data-translate="caste">Caste</th>
                    <th data-translate="staff_designation_label">Designation</th>
                    <th data-translate="staff_workplace_label">Workplace</th>
                    <th data-translate="mobile">Mobile</th>
                    <th data-translate="house_voters_col">House Voters</th>
                    <th data-translate="actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="staffDirectoryBody">
                  <tr>
                    <td colspan="8" data-translate="no_staff_found">No staff records found.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>


          <section id="deceasedListSection" class="panel" style="margin-top: 0 !important; padding-top: 1rem;">
            <div class="panel-header"
              style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
              <div>
                <h2 data-translate="deceased_list_title">Deceased Voter List</h2>
                <p style="color:var(--text-muted);" data-translate="deceased_list_desc">List of voters marked as
                  deceased. You can restore them if needed.</p>
              </div>
              <div>
                <button type="button" class="export-btn" id="exportDeceasedList" style="margin-right: 1rem;">
                  <i class="fas fa-file-excel"></i> <span data-translate="export_excel_btn">Export Excel</span>
                </button>
                <span style="background:var(--danger); color:white; padding: 0.2rem 0.6rem; border-radius:4px;">Total:
                  <span id="deceasedCount">0</span></span>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-translate="booth">Booth</th>
                    <th data-translate="voter_list_no_label">List No</th>
                    <th data-translate="name_col">Name</th>
                    <th data-translate="gender_label">Gender</th>
                    <th data-translate="epic">EPIC</th>
                    <th data-translate="actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="deceasedTableBody">
                </tbody>
              </table>
            </div>
          </section>

          <section id="familyManagementSection" class="panel" style="margin-top: 0 !important; padding-top: 1rem;">
            <div
              style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
              <h2 data-translate="family_management_title" style="margin: 0;">Family Management</h2>
              <button class="ghost" id="exportFamilyData" style="border-color: var(--success); color: var(--success);">
                <i class="fas fa-file-excel"></i> Export Family Data
              </button>
            </div>
            <p style="color:var(--text-muted); margin-bottom:1.5rem;">Manage voter families by linking members to
              identified Family Heads.</p>
            <div class="table-wrapper">
              <table style="border-collapse: collapse;">
                <thead>
                  <tr>
                    <th rowspan="2" style="background: rgba(255,255,255,0.05);">FAMALY HEAD</th>
                    <th colspan="6"
                      style="text-align: center; background: rgba(16, 185, 129, 0.1); color: var(--success);">
                      Family
                      Members</th>
                    <th rowspan="2" style="background: rgba(255,255,255,0.05); text-align: center;">Actions</th>
                  </tr>
                  <tr>
                    <th
                      style="font-size: 0.75rem; width: 35px; text-align: center; white-space: normal; line-height: 1.1;">
                      LIST NO</th>
                    <th style="font-size: 0.8rem;">VOTER NAME</th>
                    <th style="font-size: 0.8rem;">EPIC NO</th>
                    <th
                      style="font-size: 0.75rem; width: 50px; text-align: center; white-space: normal; line-height: 1.1;">
                      BOOTH NO</th>
                    <th style="font-size: 0.8rem;">MOBILE</th>
                    <th style="font-size: 0.8rem;">ADDRESS</th>
                  </tr>
                </thead>
                <tbody id="familyHeadBody">
                  <tr>
                    <td colspan="6" style="text-align: center; padding: 2rem;">Loading family heads...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="duplicateListSection" class="panel" style="margin-top: 0 !important; padding-top: 1rem;">
            <div class="panel-header"
              style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
              <div>
                <h2 data-translate="duplicate_list_title">Duplicate Voter List</h2>
                <p style="color:var(--text-muted);" data-translate="duplicate_list_desc">List of potential duplicate
                  voters detected in the system.</p>
              </div>
              <div>
                <button type="button" class="export-btn" id="exportDuplicateList" style="margin-right: 1rem;">
                  <i class="fas fa-file-excel"></i> <span data-translate="export_excel_btn">Export Excel</span>
                </button>
                <span style="background:var(--danger); color:white; padding: 0.2rem 0.6rem; border-radius:4px;">Total:
                  <span id="duplicateCount">0</span></span>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-translate="name_col">Name</th>
                    <th data-translate="gender_label">Gender</th>
                    <th data-translate="duplicate_records">Duplicate Records</th>
                    <th data-translate="actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="duplicateListTableBody">
                </tbody>
              </table>
            </div>
          </section>



          <section id="votedListSection" class="panel" style="margin-top: 0 !important; padding-top: 1rem;">
            <div class="panel-header"
              style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
              <div>
                <h2 data-translate="voted_list_title">Voted Voter List</h2>
                <p style="color:var(--text-muted);" data-translate="voted_list_desc">List of voters who have completed
                  their voting.</p>
              </div>
              <div>
                <button type="button" class="export-btn" id="exportVotedList" style="margin-right: 0.5rem;">
                  <i class="fas fa-file-excel"></i> <span data-translate="export_excel_btn">Export Excel</span>
                </button>
                <button type="button" class="download-btn" id="printVotedList" style="margin-right: 1rem;">
                  <i class="fas fa-print"></i> <span data-translate="print_report">Print Report</span>
                </button>
                <span style="background:var(--success); color:white; padding: 0.2rem 0.6rem; border-radius:4px;">Total
                  Voted:
                  <span id="votedCount">0</span></span>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-translate="booth">Booth</th>
                    <th data-translate="voter_list_no_label">List No</th>
                    <th data-translate="name_col">Name</th>
                    <th data-translate="gender_label">Gender</th>
                    <th data-translate="epic">EPIC</th>
                    <th data-translate="actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="votedTableBody">
                </tbody>
              </table>
            </div>
          </section>

          <section id="searchVoterSection" class="panel" style="text-align: center;">
            <h2 data-translate="search_voter_title">Search Voter</h2>
            <p style="color: var(--text-muted); margin-bottom: 2.5rem; max-width: 600px; margin-left: auto; margin-right: auto;"
              data-translate="search_voter_desc">Search for a
              voter by name or EPIC number and
              print their slip</p>

            <div class="search-container">
              <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchVoterInput" data-translate-placeholder="search_query_placeholder"
                  placeholder="Type name or EPIC number..." autocomplete="off" />
              </div>

              <div id="searchResults"></div>
            </div>
          </section>

          <section id="analyticsSection" class="panel">
            <h2 data-translate="analytics_title">Analytics</h2>
            <div
              style="margin-bottom: 2rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1.5rem;">
              <div class="analytics-tabs">
                <button class="role-button active" type="button" data-analytics-tab="boothNo"
                  data-translate="booth_wise">Booth Wise</button>
                <button class="role-button" type="button" data-analytics-tab="caste" data-translate="caste_wise">Caste
                  Wise</button>
                <button class="role-button" type="button" data-analytics-tab="gender"
                  data-translate="gender_wise">Gender Wise</button>
                <button class="role-button" type="button" data-analytics-tab="district"
                  data-translate="district_wise">District Wise</button>
              </div>
              <button type="button" class="export-btn" id="printAnalyticsSummary">
                <i class="fas fa-print"></i> <span data-translate="print_report">Print Report</span>
              </button>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th id="analyticsCategoryHeader" data-translate="category_header">Category</th>
                    <th data-translate="total_voters_header">Total Voters</th>
                    <th data-translate="male_header">Male</th>
                    <th data-translate="female_header">Female</th>
                    <th data-translate="other_header">Other</th>
                    <th data-translate="actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="analyticsBody">
                  <tr>
                    <td colspan="6" data-translate="loading_analytics">Loading analytics...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>
















          <section id="userLoginsSection" class="panel">
            <h2 data-translate="user_logins_title">User Logins</h2>
            <p style="color:var(--text-muted); margin-bottom:1.5rem;" data-translate="user_logins_desc">List of users
              who have logged in via Google.</p>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-translate="user_name_col">User Name</th>
                    <th data-translate="email_col">Email</th>
                    <th data-translate="last_login_col">Last Login</th>
                    <th data-translate="status_col">Status</th>
                  </tr>
                </thead>
                <tbody id="userLoginsBody">
                  <tr>
                    <td colspan="4">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="manageAdminSection" class="panel">
            <h2 data-translate="manage_admin_title">Manage Admin Logins</h2>
            <p style="color:var(--text-muted); margin-bottom:1.5rem;" data-translate="manage_admin_desc">Create new
              admin accounts that can access the
              dashboard.</p>

            <form id="createAdminForm"
              style="background: rgba(30, 41, 59, 0.4); border: 1px solid var(--bg-card-border); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem;">
              <div class="grid-two">
                <div>
                  <label for="newAdminName" data-translate="full_name_label">Full Name</label>
                  <input type="text" id="newAdminName" data-translate-placeholder="full_name_placeholder"
                    placeholder="Enter name" required />
                </div>
                <div>
                  <label for="newAdminEmail" data-translate="email_address_label">Email Address</label>
                  <input type="email" id="newAdminEmail" data-translate-placeholder="email_placeholder"
                    placeholder="Enter email" required />
                </div>
                <div>
                  <label for="newAdminPassword" data-translate="password_label">Password</label>
                  <input type="password" id="newAdminPassword" data-translate-placeholder="password_placeholder"
                    placeholder="Set password" required />
                </div>
              </div>
              <button class="primary" type="submit" style="margin-top: 1rem;" data-translate="create_admin_btn">Create
                Admin Account</button>
            </form>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-translate="name">Name</th>
                    <th data-translate="email_col">Email</th>
                    <th data-translate="created_at_col">Created At</th>
                    <th data-translate="actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="adminListBody">
                  <tr>
                    <td colspan="4" data-translate="loading">Loading admins...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>


        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal" id="editVoterModal">
    <div class="modal-card">
      <header class="modal-header" style="align-items: center;">
        <h3 style="margin:0;" data-translate="edit_voter_title">Edit Voter Record</h3>
        <button class="modal-close" type="button" id="editModalClose">&times;</button>
      </header>
      <form id="editVoterForm">
        <div class="grid-two">
          <div>
            <label for="editListNo" data-translate="voter_list_no_label">Voter List No.</label>
            <input type="text" id="editListNo" required />
          </div>
          <div>
            <label for="editBoothNo" data-translate="booth_no_label">Booth No.</label>
            <input type="text" id="editBoothNo" required />
          </div>
          <div>
            <label for="editVoterName" data-translate="voter_name_label">Voter Name (English)</label>
            <input type="text" id="editVoterName" required />
          </div>
          <div>
            <label for="editVoterNameMr" data-translate="voter_name_mr_label">Voter Name (Marathi)</label>
            <input type="text" id="editVoterNameMr" />
          </div>
          <div>
            <label for="editEpicNo" data-translate="epic_no_label">EPIC No.</label>
            <input type="text" id="editEpicNo" required />
          </div>
          <div>
            <label for="editMobileNo" data-translate="mobile_no_label">Mobile No.</label>
            <input type="tel" id="editMobileNo" maxlength="10" />
          </div>
          <div>
            <label for="editDistrict" data-translate="district">District</label>
            <input type="text" id="editDistrict" required />
          </div>
          <div>
            <label for="editTaluka" data-translate="taluka">Taluka</label>
            <input type="text" id="editTaluka" required />
          </div>
          <div>
            <label for="editGender" data-translate="gender">Gender</label>
            <input type="text" id="editGender" />
          </div>
          <div>
            <label for="editVillage" data-translate="village_label">Village</label>
            <input type="text" id="editVillage" />
          </div>
          <div>
            <label for="editCaste" data-translate="caste">Caste</label>
            <select id="editCaste" required>
              <option value="">Select Caste</option>
            </select>
          </div>
          <div>
            <label for="editVoterType" data-translate="voter_type_label">Voter Type</label>
            <select id="editVoterType" required>
              <option value="" data-translate="select_type">Select Type</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
          </div>
          <div class="toggle-group" id="editFamilyHeadToggleGroup">
            <label for="editIsFamilyHead" data-translate="is_family_head">Is Family Head?</label>
            <label class="switch">
              <input type="checkbox" id="editIsFamilyHead" />
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div style="margin-top:1rem;">
          <label for="editAddress" data-translate="address_label">Address</label>
          <textarea id="editAddress" rows="3"></textarea>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:0.75rem;margin-top:1.2rem;flex-wrap:wrap;">
          <button type="button" class="ghost" id="editModalCancel" data-translate="cancel_btn">Cancel</button>
          <button type="submit" class="primary" data-translate="save_changes_btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="analyticsModal">
    <div class="modal-card fullscreen">
      <header class="modal-header"
        style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
        <!-- Left: Chip -->
        <div>
          <span id="analyticsModalChip"
            style="font-size: 0.9rem; color: var(--primary); font-weight: 600; text-transform: uppercase;"></span>
        </div>
        <!-- Center: Title -->
        <h3 id="analyticsModalTitle" style="margin:0; font-family:'Syne',sans-serif; text-align:center;"
          data-translate="voter_list_modal_title">Voter List</h3>
        <!-- Right: Actions -->
        <div style="display:flex; gap:1rem; align-items:center; justify-content: flex-end;">
          <button class="ghost" type="button" id="analyticsModalPrint"
            style="padding: 0.5rem 1rem; font-size: 0.85rem; border-color: var(--primary); color: var(--primary);">
            <i class="fas fa-print"></i> <span data-translate="print">PRINT</span>
          </button>
          <button class="ghost" type="button" id="analyticsModalExport"
            style="padding: 0.5rem 1rem; font-size: 0.85rem;">
            <i class="fas fa-file-excel"></i> <span data-translate="export">EXPORT</span>
          </button>
          <button class="modal-close" type="button" id="analyticsModalClose" style="line-height:1;">&times;</button>
        </div>
      </header>
      <div class="analytics-scroll">
        <table>
          <thead>
            <tr>
              <th>List No.</th>
              <th>Name</th>
              <th>EPIC</th>
              <th>Booth</th>
              <th>District</th>
              <th>Taluka</th>
              <th>Caste</th>
              <th>Gender</th>
              <th>Mobile</th>
              <th>Address</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="analyticsList"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal" id="editStaffModal">
    <div class="modal-card">
      <header class="modal-header" style="align-items: center;">
        <h3 style="margin:0;">Edit Staff Record</h3>
        <button class="modal-close" type="button" id="editStaffModalClose">&times;</button>
      </header>
      <form id="editStaffForm">
        <div class="grid-two">
          <div>
            <label for="editStaffName" data-translate="staff_name_label">Name (EN)</label>
            <input type="text" id="editStaffName" required />
          </div>
          <div>
            <label for="editStaffNameMr" data-translate="staff_name_mr_label">Name (MR)</label>
            <input type="text" id="editStaffNameMr" />
          </div>
          <div>
            <label for="editStaffBooth" data-translate="booth_no_label">Booth No.</label>
            <input type="text" id="editStaffBooth" required />
          </div>
          <div>
            <label for="editStaffCaste" data-translate="staff_caste_label">Caste (EN)</label>
            <select id="editStaffCaste" required>
              <option value="">Select Caste</option>
            </select>
          </div>
          <div>
            <label for="editStaffCasteMr" data-translate="staff_caste_mr_label">Caste (MR)</label>
            <input type="text" id="editStaffCasteMr" />
          </div>
          <div>
            <label for="editStaffDesignation" data-translate="staff_designation_label">Designation (EN)</label>
            <input type="text" id="editStaffDesignation" required />
          </div>
          <div>
            <label for="editStaffDesignationMr" data-translate="staff_designation_mr_label">Designation (MR)</label>
            <input type="text" id="editStaffDesignationMr" />
          </div>
          <div>
            <label for="editStaffWorkplace" data-translate="staff_workplace_label">Workplace (EN)</label>
            <input type="text" id="editStaffWorkplace" required />
          </div>
          <div>
            <label for="editStaffWorkplaceMr" data-translate="staff_workplace_mr_label">Workplace (MR)</label>
            <input type="text" id="editStaffWorkplaceMr" />
          </div>
          <div>
            <label for="editStaffMobile" data-translate="mobile_no_label">Mobile</label>
            <input type="tel" id="editStaffMobile" maxlength="10" />
          </div>
          <div>
            <label for="editStaffHouse" data-translate="staff_house_count_label">House Voters</label>
            <input type="number" id="editStaffHouse" min="0" />
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:0.75rem;margin-top:1.2rem;flex-wrap:wrap;">
          <button type="button" class="ghost" id="editStaffModalCancel" data-translate="cancel_btn">Cancel</button>
          <button type="submit" class="primary" data-translate="save_changes_btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="assignVotersModal">
    <div class="modal-card fullscreen">
      <header class="modal-header"
        style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
        <div></div>
        <h3 style="margin:0; font-family:'Syne',sans-serif; text-align:center;">Assign Voters</h3>
        <div style="display:flex; gap:1rem; align-items:center; justify-content: flex-end;">
          <button class="modal-close" type="button" id="assignVotersClose" style="line-height:1;">&times;</button>
        </div>
      </header>
      <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); background: var(--bg-card);">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="assignVotersSearch" placeholder="Search voters to assign..." style="width: 100%;" />
        </div>
        <div style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
          <div class="role-toggle" style="margin: 0; background: rgba(0,0,0,0.3);">
            <button class="role-button active" type="button" data-assign-filter="unassigned">Unassigned</button>
            <button class="role-button" type="button" data-assign-filter="assigned">Assigned</button>
          </div>
          <span id="assignVotersCount" style="font-weight: bold; color: var(--primary);">Selected: 0</span>
        </div>
      </div>
      <div class="analytics-scroll">
        <table>
          <thead>
            <tr>
              <th style="width: 60px; text-align: center;">Select</th>
              <th>Name</th>
              <th>EPIC</th>
              <th>Booth</th>
              <th>Address</th>
            </tr>
          </thead>
          <tbody id="assignVotersList">
            <tr>
              <td colspan="5">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer" style="padding: 1rem; text-align: right; border-top: 1px solid rgba(255,255,255,0.1);">
        <button class="ghost" id="assignVotersExport"
          style="margin-right: auto; border-color: var(--success); color: var(--success);">
          <i class="fas fa-file-excel"></i> Export Assigned
        </button>
        <button class="ghost" id="assignVotersCancel" style="margin-right: 1rem;">Cancel</button>
        <button class="primary" id="assignVotersSave">Save Assignments</button>
      </div>
    </div>
  </div>

  <div class="modal" id="linkMembersModal">
    <div class="modal-card fullscreen">
      <header class="modal-header">
        <h3 style="margin:0;" data-translate="select_family_members">Select Family Members</h3>
        <button class="modal-close" type="button" id="linkMembersClose">&times;</button>
      </header>
      <div style="padding: 1rem; background: var(--bg-card);">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="linkMembersSearch" placeholder="Search members to link..." style="width: 100%;" />
        </div>
      </div>
      <div class="analytics-scroll">
        <table>
          <thead>
            <tr>
              <th style="width: 60px; text-align: center;">Select</th>
              <th>Name</th>
              <th>EPIC</th>
              <th>Address</th>
            </tr>
          </thead>
          <tbody id="linkMembersList">
            <tr>
              <td colspan="4">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="ghost" id="linkMembersCancel">Cancel</button>
        <button class="primary" id="linkMembersSave">Save Family</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase configuration (public client keys intentionally exposed per Firebase guidelines)
    const firebaseConfig = {
      apiKey: "AIzaSyBal190E90bHyKbgf41ipQF6cFqYuI5pNo",
      authDomain: "raygaon-voter-system.firebaseapp.com",
      databaseURL: "https://raygaon-voter-system-default-rtdb.firebaseio.com",
      projectId: "raygaon-voter-system",
      storageBucket: "raygaon-voter-system.firebasestorage.app",
      messagingSenderId: "493283837074",
      appId: "1:493283837074:web:77de29cba0ba3afd4d124b",
      measurementId: "G-7RENM3JGMD"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const ADMIN_CREDENTIALS = {
      email: "ghadage.adhikrao3@gmail.com",
      password: "adhik1993",
      displayName: "Adhikrao Ghadage"
    };
    const ADMIN_SESSION_KEY = "raygaon-admin-session";

    const districtTalukaMap = {
      "Ahmednagar": ["Akole", "Jamkhed", "Karjat", "Kopargaon", "Nagar", "Nevasa", "Parner", "Pathardi", "Rahata", "Rahuri", "Sangamner", "Shevgaon", "Shrigonda", "Shrirampur"],
      "Akola": ["Akola", "Akot", "Balapur", "Barshitakli", "Murtizapur", "Patur", "Telhara"],
      "Amravati": ["Achalpur", "Amravati", "Anjangaon", "Bhatkuli", "Chandur Bazar", "Chandur Railway", "Chikhaldara", "Daryapur", "Dhamangaon", "Morshi", "Nandgaon-Khandeshwar", "Teosa", "Warud"],
      "Chhatrapati Sambhajinagar": ["Aurangabad", "Gangapur", "Kannad", "Khuldabad", "Paithan", "Phulambri", "Sillod", "Soegaon", "Vaijapur"],
      "Beed": ["Ambejogai", "Ashti", "Beed", "Dharur", "Georai", "Kaij", "Majalgaon", "Parli", "Patoda", "Shirur (Kasar)", "Wadwani"],
      "Bhandara": ["Bhandara", "Lakhandur", "Lakhani", "Mohadi", "Pauni", "Sakoli", "Tumsar"],
      "Buldhana": ["Buldhana", "Chikhli", "Deulgaon Raja", "Jalgaon Jamod", "Khamgaon", "Lonar", "Malkapur", "Mehkar", "Motala", "Nandura", "Sangrampur", "Shegaon", "Sindkhed Raja"],
      "Chandrapur": ["Ballarpur", "Bhadravati", "Brahmapuri", "Chandrapur", "Chimur", "Gondpipri", "Jiwati", "Korpana", "Mul", "Nagbhid", "Pombhurna", "Rajura", "Saoli", "Sindewahi", "Warora"],
      "Dhule": ["Dhule", "Sakri", "Shirpur", "Shindkheda"],
      "Gadchiroli": ["Aheri", "Armori", "Bhamragad", "Chamorshi", "Desaiganj", "Dhanora", "Etapalli", "Gadchiroli", "Korchi", "Kurkheda", "Mulchera", "Sironcha"],
      "Gondia": ["Amgaon", "Arjuni Morgaon", "Deori", "Goregaon", "Gondia", "Sadak Arjuni", "Salekasa", "Tirora"],
      "Hingoli": ["Aundha", "Basmath", "Hingoli", "Kalamnuri", "Sengaon"],
      "Jalgaon": ["Amalner", "Bhadgaon", "Bhusawal", "Bodwad", "Chalisgaon", "Chopda", "Dharangaon", "Erandol", "Jalgaon", "Jamner", "Muktainagar", "Pachora", "Parola", "Raver", "Yawal"],
      "Jalna": ["Ambad", "Badnapur", "Bhokardan", "Ghansawangi", "Jafferabad", "Jalna", "Mantha", "Partur"],
      "Kolhapur": ["Ajra", "Bavda", "Bhudargad", "Chandgad", "Gadhinglaj", "Gaganbawada", "Hatkanangle", "Kagal", "Karveer", "Panhala", "Radhanagari", "Shahuwadi"],
      "Latur": ["Ahmedpur", "Ausa", "Chakur", "Deoni", "Jalkot", "Latur", "Nilanga", "Renapur", "Shirur (Anantpal)", "Udgir"],
      "Mumbai": ["Andheri", "Borivali", "Kurla", "Fort", "Malabar Hill", "Mohammad Ali Road", "Byculla", "Dadar"],
      "Mumbai City": ["Fort", "Malabar Hill", "Mohammad Ali Road", "Byculla", "Dadar"],
      "Mumbai Suburban": ["Andheri", "Borivali", "Kurla"],
      "Nagpur": ["Bhiwapur", "Hingna", "Kalameshwar", "Kamthi", "Katol", "Kuhi", "Mauda", "Nagpur Rural", "Narkhed", "Parshivni", "Ramtek", "Savner", "Umred"],
      "Nanded": ["Ardhapur", "Bhokar", "Biloli", "Degloor", "Dharmabad", "Hadgaon", "Himayatnagar", "Kandhar", "Kinwat", "Loha", "Mahoor", "Mudkhed", "Mukhed", "Naigaon", "Nanded"],
      "Nandurbar": ["Akkalkuwa", "Akrani", "Nandurbar", "Navapur", "Shahada", "Talode"],
      "Nashik": ["Baglan", "Chandwad", "Deola", "Dindori", "Igatpuri", "Kalwan", "Malegaon", "Nandgaon", "Nashik", "Niphad", "Peint", "Sinnar", "Surgana", "Trimbakeshwar", "Yeola"],
      "Osmanabad (Dharashiv)": ["Bhoom", "Kalamb", "Lohara", "Nilanga", "Osmanabad", "Paranda", "Tuljapur", "Umarga", "Washi"],
      "Palghar": ["Dahanu", "Jawhar", "Mokhada", "Palghar", "Talasari", "Vasai", "Vikramgad", "Wada"],
      "Parbhani": ["Gangakhed", "Jintur", "Manwat", "Palam", "Parbhani", "Pathri", "Purna", "Sailu", "Sonpeth"],
      "Pune": ["Ambegaon", "Baramati", "Bhor", "Daund", "Haveli", "Indapur", "Junnar", "Khed", "Maval", "Mulshi", "Pune City", "Purandar", "Shirur", "Velhe"],
      "Raigad": ["Alibag", "Karjat", "Khalapur", "Mahad", "Mangaon", "Mhasla", "Murud", "Panvel", "Pen", "Poladpur", "Roha", "Shrivardhan", "Sudhagad", "Uran"],
      "Ratnagiri": ["Chiplun", "Dapoli", "Guhagar", "Khed", "Lanja", "Mandangad", "Rajapur", "Ratnagiri", "Sangameshwar"],
      "SANGLI": ["Atpadi", "Jat", "Kadegaon", "Kavathe Mahankal", "Khanapur", "Miraj", "Palus", "Shirala", "Tasgaon", "Walwa"],
      "Satara": ["Jaoli", "Karad", "Khatav", "Khandala", "Koregaon", "Mahabaleshwar", "Man", "Patan", "Phaltan", "Satara", "Wai"],
      "Sindhudurg": ["Devgad", "Dodamarg", "Kankavli", "Kudal", "Malwan", "Sawantwadi", "Vaibhavwadi", "Vengurla"],
      "Solapur": ["Akkalkot", "Barshi", "Karmala", "Mangalwedha", "Madha", "Mohol", "Pandharpur", "Sangole", "Solapur North", "Solapur South"],
      "Thane": ["Ambarnath", "Bhiwandi", "Kalyan", "Murbad", "Shahapur", "Thane", "Ulhasnagar"],
      "Wardha": ["Arvi", "Ashti", "Deoli", "Hinganghat", "Karanja", "Samudrapur", "Seloo", "Wardha"],
      "Washim": ["Karanja", "Malegaon", "Mangrulpir", "Manora", "Risod", "Washim"],
      "Yavatmal": ["Arni", "Babulgaon", "Darwha", "Digras", "Ghatanji", "Kalamb", "Kelapur", "Mahagaon", "Maregaon", "Ner", "Pandharkaoda", "Pusad", "Ralegaon", "Umarkhed", "Wani", "Yavatmal"]
    };

    const casteOptions = ["MARATHA", "MATANG", "NABIK", "GURAV", "BOUDH", "KOLI", "CHAMBAR", "MUSLIM", "RAMOSHI", "BELDAR", "VANI", "NAMAN", "DHANGAR", "SONAR"];
    const voterCSVHeaders = ["boothNo", "listNo", "voterName", "voterNameMr", "epicNo", "mobileNo", "district", "taluka", "gender", "voterType", "caste", "village", "address", "isFamilyHead"];
    const staffCSVHeaders = ["name", "boothNo", "caste", "designation", "workplace", "mobile", "houseVoters"];
    const voterSampleData = [
      voterCSVHeaders,
      ["2", "101", "Aarav Patil", "आरव पाटील", "ABC1234567", "9876543210", "Pune", "Haveli", "Male", "A", "NAMAN", "Raygaon", "House No. 10, Ward 3"],
      ["3", "102", "Sneha Deshmukh", "स्नेहा देशमुख", "XYZ7654321", "8765432109", "Nashik", "Sinnar", "Female", "B", "MARATHA", "Raygaon", "Opp. Gram Panchayat"]
    ];
    const staffSampleData = [
      staffCSVHeaders,
      ["Rahul Kulkarni", "2", "OBC", "Booth Manager", "Raygaon College", "9988776655", "6"],
      ["Priya Jadhav", "3", "SC", "Supervisor", "Raygaon High School", "8877665544", "4"]
    ];

    const state = {
      lang: localStorage.getItem("raygaon-lang") || "en",
      role: "guest",
      profile: null,
      voters: [],
      staff: [],
      users: [],
      admins: []
    };

    const refs = {
      authSection: document.getElementById("authSection"),
      dashboard: document.getElementById("dashboard"),
      statusBadge: document.getElementById("statusBadge"),
      welcomeText: document.getElementById("welcomeText"),
      signOutBtn: document.getElementById("signOutBtn"),
      adminStatus: document.getElementById("adminStatus"),
      navButtons: document.querySelectorAll(".nav-button"),
      panels: document.querySelectorAll("section.panel"),
      voterTableBody: document.getElementById("voterTableBody"),
      filterDistrict: document.getElementById("filterDistrict"),
      filterTaluka: document.getElementById("filterTaluka"),
      filterBooth: document.getElementById("filterBooth"),
      filterCaste: document.getElementById("filterCaste"),
      filterGender: document.getElementById("filterGender"),
      filterVoterType: document.getElementById("filterVoterType"),
      searchText: document.getElementById("searchText"),
      exportVoterDirectory: document.getElementById("exportVoterDirectory"),
      toast: document.getElementById("toast"),
      voterImportInput: document.getElementById("importVoterCSV"),
      staffImportInput: document.getElementById("importStaffCSV"),
      voterSampleBtn: document.getElementById("downloadVoterSample"),
      staffSampleBtn: document.getElementById("downloadStaffSample"),
      voterProgress: {
        container: document.getElementById("voterProgressContainer"),
        bar: document.getElementById("voterProgressBar"),
        stats: document.getElementById("voterImportStats"),
        percent: document.getElementById("voterProgressPercent"),
        count: document.getElementById("voterProgressCount")
      },
      staffProgress: {
        container: document.getElementById("staffProgressContainer"),
        bar: document.getElementById("staffProgressBar"),
        stats: document.getElementById("staffImportStats"),
        percent: document.getElementById("staffProgressPercent"),
        count: document.getElementById("staffProgressCount")
      },
      editModal: document.getElementById("editVoterModal"),
      editModalClose: document.getElementById("editModalClose"),
      editModalCancel: document.getElementById("editModalCancel"),
      editForm: document.getElementById("editVoterForm"),
      editFields: {
        listNo: document.getElementById("editListNo"),
        boothNo: document.getElementById("editBoothNo"),
        voterName: document.getElementById("editVoterName"),
        voterNameMr: document.getElementById("editVoterNameMr"),
        epicNo: document.getElementById("editEpicNo"),
        mobileNo: document.getElementById("editMobileNo"),
        district: document.getElementById("editDistrict"),
        taluka: document.getElementById("editTaluka"),
        gender: document.getElementById("editGender"),
        voterType: document.getElementById("editVoterType"),
        caste: document.getElementById("editCaste"),
        village: document.getElementById("editVillage"),
        address: document.getElementById("editAddress"),
        isFamilyHead: document.getElementById("editIsFamilyHead")
      },
      analyticsModal: document.getElementById("analyticsModal"),
      analyticsModalClose: document.getElementById("analyticsModalClose"),
      analyticsModalPrint: document.getElementById("analyticsModalPrint"),
      analyticsModalExport: document.getElementById("analyticsModalExport"),
      analyticsList: document.getElementById("analyticsList"),
      analyticsModalChip: document.getElementById("analyticsModalChip"),
      analyticsModalTitle: document.getElementById("analyticsModalTitle"),
      analyticsSection: document.getElementById("analyticsSection"),
      votedTableBody: document.getElementById("votedTableBody"),
      votedCount: document.getElementById("votedCount"),
      votedSummaryCount: document.getElementById("votedSummaryCount"),
      totalVotingPercent: document.getElementById("totalVotingPercent"),
      exportVotedList: document.getElementById("exportVotedList"),
      printVotedList: document.getElementById("printVotedList"),
      printAnalyticsSummary: document.getElementById("printAnalyticsSummary"),
      boothAnalyticsBody: document.getElementById("boothAnalyticsBody"),
      staffFilterBooth: document.getElementById("staffFilterBooth"),
      staffFilterCaste: document.getElementById("staffFilterCaste"),
      staffSearchText: document.getElementById("staffSearchText"),
      staffDirectoryBody: document.getElementById("staffDirectoryBody"),
      exportStaffDirectory: document.getElementById("exportStaffDirectory"),
      staffModal: document.getElementById("editStaffModal"),
      staffModalClose: document.getElementById("editStaffModalClose"),
      staffModalCancel: document.getElementById("editStaffModalCancel"),
      staffEditForm: document.getElementById("editStaffForm"),
      staffEditFields: {
        name: document.getElementById("editStaffName"),
        nameMr: document.getElementById("editStaffNameMr"),
        boothNo: document.getElementById("editStaffBooth"),
        caste: document.getElementById("editStaffCaste"),
        casteMr: document.getElementById("editStaffCasteMr"),
        designation: document.getElementById("editStaffDesignation"),
        designationMr: document.getElementById("editStaffDesignationMr"),
        workplace: document.getElementById("editStaffWorkplace"),
        workplaceMr: document.getElementById("editStaffWorkplaceMr"),
        mobile: document.getElementById("editStaffMobile"),
        houseVoters: document.getElementById("editStaffHouse")
      },
      userLoginsBody: document.getElementById("userLoginsBody"),
      createAdminForm: document.getElementById("createAdminForm"),
      adminListBody: document.getElementById("adminListBody"),
      familyHeadBody: document.getElementById("familyHeadBody"),
      familySidebarList: document.getElementById("familySidebarList"),
      linkMembersModal: document.getElementById("linkMembersModal"),
      linkMembersClose: document.getElementById("linkMembersClose"),
      linkMembersCancel: document.getElementById("linkMembersCancel"),
      linkMembersSave: document.getElementById("linkMembersSave"),
      linkMembersSearch: document.getElementById("linkMembersSearch"),
      linkMembersList: document.getElementById("linkMembersList"),
      exportFamilyData: document.getElementById("exportFamilyData")
    };

    let editingVoterId = null;
    let editingStaffId = null;
    let linkingFamilyHeadId = null;
    let selectedFamilyMemberIds = new Set();
    let analyticsFilterMeta = null;

    const dictionary = {
      en: {
        sign_out: "Sign Out",
        nav_overview: "Overview",
        nav_add_voter: "Add Voter",
        nav_staff_info: "Staff Info",
        nav_search: "Search Voter",
        nav_analytics: "Analytics",
        nav_smart_tools: "Duplicate Voter",
        smart_tools_title: "Duplicate Voter Detector",
        smart_tools_desc: "Advanced tool for voter list cleaning.",
        duplicate_finder_tab: "Duplicate Finder",
        find_duplicates_heading: "Duplicate Voter Detector",
        find_duplicates_desc: "Detects voters with identical names and genders to help clean the list.",
        scan_duplicates_btn: "Scan For Duplicates",
        scan_results: "Scan Results",
        nav_directory: "VOTER DIRECTORY",
        nav_staff_directory: "STAFF DIRECTORY",
        nav_user_logins: "USER LOGINS",
        nav_manage_admin: "MANAGE ADMIN",
        nav_family_management: "FAMILY MANAGEMENT",
        family_management_title: "Family Management",
        link_members: "Link Members",
        family_members_count: "Family Members",
        select_family_members: "Select Family Members",
        dash_overview: "Dashboard Overview",
        total_voters: "TOTAL REGISTERED VOTERS",
        female_voters: "FEMALE VOTERS",
        male_voters: "MALE VOTERS",
        staff_count: "STAFF RECORDS",
        add_voter_desc: "Enter voter information for any Maharashtra district. Taluka options refresh based on the selected district.",
        welcome: "Welcome",
        booth: "Booth",
        voters: "Voters",
        actions: "Actions",
        name: "Name",
        epic: "EPIC",
        district: "District",
        staff_name_label: "Name of Staff (EN)",
        staff_name_mr_label: "Name of Staff (MR)",
        staff_designation_label: "Designation (EN)",
        staff_designation_mr_label: "Designation (MR)",
        staff_workplace_label: "Working College / Office (EN)",
        staff_workplace_mr_label: "Working College / Office (MR)",
        staff_caste_label: "Caste (EN)",
        staff_caste_mr_label: "Caste (MR)",
        caste_label: "Caste",
        village_label: "Village",
        staff_house_count_label: "Total Voters in House",
        save_staff_record_btn: "Save Staff Record",
        search_voter_title: "Search Voter",
        search_voter_desc: "Search for a voter by name or EPIC number and print their slip",
        enter_search_query_label: "Enter Voter Name or EPIC Number",
        search_query_placeholder: "Type name or EPIC number...",
        analytics_title: "Analytics",
        booth_wise: "Booth Wise",
        caste_wise: "Caste Wise",
        gender_wise: "Gender Wise",
        district_wise: "District Wise",
        category_header: "Category",
        total_voters_header: "Total Voters",
        male_header: "MALE",
        female_header: "FEMALE",
        other_header: "OTHER",
        loading_analytics: "Loading analytics...",
        voter_directory_title: "VOTER DIRECTORY",
        export_excel_btn: "EXPORT EXCEL",
        filter_voters_desc: "FILTER VOTERS BY DISTRICT, TALUKA, CASTE, GENDER, OR VOTER TYPE AND EXPORT TO EXCEL.",
        search_placeholder: "SEARCH NAME / EPIC",
        all_districts: "ALL DISTRICTS",
        all_talukas: "ALL TALUKAS",
        all_castes: "ALL CASTES",
        all_genders: "ALL GENDERS",
        all_types: "ALL TYPES",
        staff_directory_title: "Raygaon Staff Directory",
        filter_staff_desc: "Filter Raygaon staff by booth and caste, then export to Excel.",
        staff_search_placeholder: "Search staff by name",
        all_booths: "All Booths",
        name_col: "Name",
        house_voters_col: "House Voters",
        no_staff_found: "No staff records found.",
        bulk_import_voters: "Bulk Import Voters",
        bulk_import_desc: "Upload a CSV file to add multiple voters at once.",
        download_sample_csv: "Download Sample CSV",
        import_csv: "Import CSV",
        headers_match_template: "Headers must match template.",
        booth_no_label: "Booth No.",
        select_booth: "Select booth",
        voter_list_no_label: "Voter List No.",
        voter_name_label: "Voter Name (English)",
        voter_name_mr_label: "Voter Name (Marathi)",
        epic_no_label: "EPIC No.",
        mobile_no_label: "Mobile No.",
        district_label: "District (Maharashtra)",
        taluka_label: "Taluka",
        gender_label: "Gender",
        select_gender: "Select gender",
        village_label: "Village",
        caste_label: "Caste",
        edit_voter_title: "Edit Voter Record",
        cancel_btn: "Cancel",
        save_changes_btn: "Save Changes",
        edit_staff_title: "Edit Staff Record",
        email_col: "Email",
        last_login_col: "Last Login",
        status_col: "Status",
        manage_admin_title: "Manage Admin Logins",
        manage_admin_desc: "Create new admin accounts that can access the dashboard.",
        full_name_label: "Full Name",
        full_name_placeholder: "Enter name",
        email_address_label: "Email Address",
        email_placeholder: "Enter email",
        password_label: "Password",
        password_placeholder: "Set password",
        create_admin_btn: "Create Admin Account",
        created_at_col: "Created At",
        loading: "Loading...",
        user_logins_title: "User Logins",
        user_logins_desc: "List of users who have logged in via Google.",
        user_name_col: "User Name",
        nav_deceased_list: "Deceased List",
        deceased_list_title: "Deceased Voter List",
        deceased_list_desc: "List of voters marked as deceased. You can restore them if needed.",
        restore_btn: "Restore to List",
        mark_deceased_btn: "Mark Deceased",
        edit: "EDIT",
        delete: "DELETE",
        print: "PRINT",
        family_head_label: "Family Head",
        is_family_head: "Is Family Head?",
        status_deceased: "DEATH",
        nav_duplicate_list: "Duplicate Voter List",
        duplicate_list_title: "Duplicate Voter List",
        duplicate_list_desc: "List of potential duplicate voters detected in the system.",
        duplicate_records: "Duplicate Records",
        view_details: "View Details",
        print_report: "Print Report",
        nav_voted_list: "Voted List",
        voted_list_title: "Voted Voter List",
        voted_list_desc: "List of voters who have completed their voting.",
        mark_voted_btn: "Mark Voted",
        unmark_voted_btn: "Unmark Voted",
        voted_status: "VOTED",
        pending_votes: "PENDING VOTES"
      },
      mr: {
        sign_out: "साइन आउट",
        nav_overview: "डॅशबोर्ड माहिती",
        nav_add_voter: "मतदार जोडा",
        nav_staff_info: "कर्मचारी माहिती",
        nav_search: "मतदार शोधा",
        nav_analytics: "माहिती विश्लेषण",
        nav_smart_tools: "दुप्पट नावे शोधक",
        smart_tools_title: "दुप्पट नावे शोधक टूल्स",
        smart_tools_desc: "मतदार यादी शुद्धीकरणासाठी प्रगत साधने.",
        duplicate_finder_tab: "दुप्पट नावे शोधक",
        find_duplicates_heading: "संभाव्य दुप्पट मतदार शोधा",
        find_duplicates_desc: "समान नाव आणि लिंग असलेल्या मतदारांना शोधून यादी शुद्ध करा.",
        scan_duplicates_btn: "स्कॅन करा",
        scan_results: "स्कॅन निकाल",
        nav_directory: "मतदार यादी",
        nav_staff_directory: "कर्मचारी यादी",
        nav_user_logins: "वापरकर्ता लॉगिन",
        nav_manage_admin: "ॲडमिन व्यवस्थापन",
        nav_family_management: "कुटुंब व्यवस्थापन",
        family_management_title: "कुटुंब व्यवस्थापन",
        link_members: "सदस्य जोडा",
        family_members_count: "कुटुंब सदस्य",
        select_family_members: "कुटुंब सदस्य निवडा",
        dash_overview: "डॅशबोर्ड सारांश",
        total_voters: "एकूण नोंदणीकृत मतदार",
        female_voters: "महिला मतदार",
        male_voters: "पुरुष मतदार",
        staff_count: "एकूण कर्मचारी",
        add_voter_desc: "महाराष्ट्र जिल्ह्यातील कोणत्याही मतदाराची माहिती भरा. जिल्हा निवडल्यानंतर तालुक्याचे पर्याय दिसतील.",
        welcome: "स्वागत आहे",
        booth: "बुथ",
        voters: "मतदार",
        actions: "क्रिया",
        name: "नाव",
        epic: "एपिक (EPIC) क्र.",
        district: "जिल्हा",
        taluka: "तालुका",
        caste: "जात",
        gender: "लिंग",
        mobile: "मोबाईल",
        address: "पत्ता",
        type: "प्रकार",
        list_no: "यादी क्र.",
        nav_deceased_list: "मयत मतदार यादी",
        deceased_list_title: "मयत मतदार यादी",
        deceased_list_desc: "मयत घोषित केलेले मतदार. गरज असल्यास तुम्ही त्यांना पुन्हा यादीत घेऊ शकता.",
        restore_btn: "पुन्हा यादीत घ्या",
        mark_deceased_btn: "मयत घोषित करा",
        edit: "सुधारा",
        delete: "काढून टाका",
        print: "प्रिंट करा",
        view: "पहा",
        export: "एक्सपोर्ट",
        status_deceased: "मयत",
        booth_voters: "बुथ {0} मतदार",
        voter_type_label: "मतदार प्रकार",
        select_type: "प्रकार निवडा",
        address_label: "पत्ता",
        address_placeholder: "घर क्रमांक / गल्ली / खूण",
        save_voter_btn: "मतदार जतन करा",
        staff_info_title: "कर्मचारी माहिती (गाव: रायगाव)",
        import_staff_data: "कर्मचारी डेटा इंपोर्ट करा",
        download_sample_sheet_desc: "नमुना शीट डाउनलोड करा, भरा आणि पुन्हा अपलोड करा.",
        staff_name_label: "कर्मचाऱ्याचे नाव",
        staff_designation_label: "पद / हुद्दा",
        staff_workplace_label: "कार्यरत कार्यालय / महाविद्यालय",
        staff_house_count_label: "घरातील एकूण मतदार",
        save_staff_record_btn: "कर्मचारी माहिती जतन करा",
        search_voter_title: "मतदार शोधा",
        search_voter_desc: "नाव किंवा एपिक क्रमांकाने मतदार शोधा आणि स्लिप प्रिंट करा",
        enter_search_query_label: "मतदाराचे नाव किंवा एपिक क्र. टाका",
        search_query_placeholder: "नाव किंवा एपिक क्र. टाईप करा...",
        analytics_title: "माहिती विश्लेषण",
        booth_wise: "बुथ नुुसार",
        caste_wise: "जात नुसार",
        gender_wise: "लिंग नुसार",
        district_wise: "जिल्हा नुसार",
        category_header: "वर्गवारी",
        total_voters_header: "एकूण मतदार",
        male_header: "पुरुष",
        female_header: "महिला",
        other_header: "इतर",
        loading_analytics: "माहिती लोड होत आहे...",
        voter_directory_title: "मतदार यादी",
        export_excel_btn: "Excel एक्सपोर्ट",
        filter_voters_desc: "जिल्हा, तालुका, जात, लिंग किंवा मतदार प्रकारानुसार फिल्टर करा आणि Excel मध्ये काढा.",
        search_placeholder: "नाव / एपिक शोधा",
        all_districts: "सर्व जिल्हे",
        all_talukas: "सर्व तालुके",
        all_castes: "सर्व जाती",
        all_genders: "सर्व लिंग",
        all_types: "सर्व प्रकार",
        staff_directory_title: "रायगाव कर्मचारी यादी",
        filter_staff_desc: "बुथ आणि जातीनुसार रायगाव कर्मचारी फिल्टर करा आणि Excel मध्ये काढा.",
        staff_search_placeholder: "नावाने कर्मचारी शोधा",
        all_booths: "सर्व बुथ",
        name_col: "नाव",
        house_voters_col: "घरातील मतदार",
        no_staff_found: "कर्मचारी रेकॉर्ड सापडले नाहीत.",
        bulk_import_voters: "मोठ्या प्रमाणात मतदार इंपोर्ट करा",
        bulk_import_desc: "अनेक मतदार एकाच वेळी जोडण्यासाठी CSV फाईल अपलोड करा.",
        download_sample_csv: "नमुना CSV डाउनलोड करा",
        import_csv: "CSV इंपोर्ट करा",
        headers_match_template: "हेडर्स टेम्प्लेटशी जुळले पाहिजेत.",
        booth_no_label: "बुथ क्रमांक",
        select_booth: "बुथ निवडा",
        voter_list_no_label: "मतदार यादी क्रमांक",
        voter_name_label: "मतदाराचे नाव (इंग्रजी)",
        voter_name_mr_label: "मतदाराचे नाव (मराठी)",
        epic_no_label: "एपिक (EPIC) क्रमांक",
        mobile_no_label: "मोबाईल क्रमांक",
        district_label: "जिल्हा (महाराष्ट्र)",
        taluka_label: "तालुका",
        gender_label: "लिंग",
        staff_name_label: "कर्मचाऱ्याचे नाव (इंग्रजी)",
        staff_name_mr_label: "कर्मचाऱ्याचे नाव (मराठी)",
        staff_designation_label: "पद / हुद्दा (इंग्रजी)",
        staff_designation_mr_label: "पद / हुद्दा (मराठी)",
        staff_workplace_label: "कार्यरत कार्यालय / महाविद्यालय (इंग्रजी)",
        staff_workplace_mr_label: "कार्यरत कार्यालय / महाविद्यालय (मराठी)",
        staff_caste_label: "जात (इंग्रजी)",
        staff_caste_mr_label: "जात (मराठी)",
        caste_label: "जात",
        village_label: "गाव",
        staff_house_count_label: "घरातील एकूण मतदार",
        family_head_label: "कुटुंब प्रमुख",
        is_family_head: "कुटुंब प्रमुख आहे का?",
        nav_duplicate_list: "दुप्पट मतदार यादी",
        duplicate_list_title: "दुप्पट मतदार यादी",
        duplicate_list_desc: "प्रणालीमध्ये आढळलेल्या संभाव्य दुप्पट मतदारांची यादी.",
        duplicate_records: "दुप्पट नोंदी",
        view_details: "तपशील पहा",
        print_report: "रिपोर्ट प्रिंट करा",
        nav_voted_list: "मतदान झालेली यादी",
        voted_list_title: "मतदान केलेल्या मतदारांची यादी",
        voted_list_desc: "ज्या मतदारांनी मतदान पूर्ण केले आहे त्यांची यादी.",
        mark_voted_btn: "मतदान झाले",
        unmark_voted_btn: "मतदान रद्द करा",
        voted_status: "मतदान झाले",
        pending_votes: "बाकी मतदान",
        "MARATHA": "मराठा",
        "MATANG": "मातंग",
        "NABIK": "नाभिक",
        "GURAV": "गुरव",
        "BOUDH": "बौद्ध",
        "KOLI": "कोळी",
        "CHAMBAR": "चांभार",
        "MUSLIM": "मुस्लिम",
        "RAMOSHI": "रामोशी",
        "BELDAR": "बेलदार",
        "VANI": "वाणी",
        "NAMAN": "नमन",
        "DHANGAR": "धनगर",
        "SONAR": "सोनार"
      }
    };

    function applyTranslations() {
      const lang = state.lang;
      // Text content translations
      document.querySelectorAll("[data-translate]").forEach(el => {
        const key = el.getAttribute("data-translate");
        if (dictionary[lang][key]) {
          // If it has FontAwesome icon, preserve it
          const icon = el.querySelector("i");
          if (icon) {
            const iconClone = icon.cloneNode(true);
            el.textContent = " " + dictionary[lang][key];
            el.prepend(iconClone);
          } else {
            el.textContent = dictionary[lang][key];
          }
        }
      });

      // Placeholder translations
      document.querySelectorAll("[data-translate-placeholder]").forEach(el => {
        const key = el.getAttribute("data-translate-placeholder");
        if (dictionary[lang][key]) {
          el.setAttribute("placeholder", dictionary[lang][key]);
        }
      });

      const name = state.profile?.displayName || (state.role === "admin" ? "Adhikrao Ghadage" : (state.lang === "mr" ? "वापरकर्ता" : "User"));
      refs.welcomeText.textContent = `${dictionary[state.lang].welcome}, ${name}!`;
    }

    document.getElementById("langSelect").addEventListener("change", (e) => {
      state.lang = e.target.value;
      localStorage.setItem("raygaon-lang", state.lang);
      updateOverview();
      renderVoterTable();
      renderStaffDirectory();
      renderUserLogins();
      renderAdmins();
      renderFamilyHeadTable();
    });

    function renderFamilyHeadTable() {
      const heads = state.voters.filter(v => v.isFamilyHead);
      const lang = state.lang;
      if (!heads.length) {
        refs.familyHeadBody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:2rem; color:var(--text-muted);">${lang === 'mr' ? 'अद्याप कोणतेही कुटुंब प्रमुख नियुक्त केलेले नाहीत.' : 'No family heads designated yet.'}</td></tr>`;
        return;
      }

      let allRows = "";
      heads.forEach(h => {
        const familyMemberIds = h.familyMembers ? Object.keys(h.familyMembers) : [];
        const members = familyMemberIds.map(mid => state.voters.find(v => v.id === mid)).filter(Boolean);

        const rowCount = Math.max(members.length, 1);

        for (let i = 0; i < rowCount; i++) {
          const m = members[i];
          let headCell = "";
          let actionCell = "";

          if (i === 0) {
            headCell = `
              <td rowspan="${rowCount}" style="vertical-align: middle; background: rgba(255,255,255,0.02); min-width: 250px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="font-weight: 700; color: var(--primary); font-size: 1rem; text-transform: uppercase;">${h.voterName}</div>
                <div style="font-weight: 600; margin: 0.2rem 0; color: var(--text-white); font-size: 0.9rem;">${h.epicNo || "---"}</div>
                <div style="display: flex; gap: 1rem;">
                  <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 800;">LIST NO <span style="color:var(--accent);">${h.listNo || "---"}</span></div>
                  <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 800;">BOOTH <span style="color:var(--accent);">${h.boothNo || "---"}</span></div>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600; margin-top: 0.2rem;">MOBILE ${h.mobileNo || ""}</div>
              </td>
            `;
            actionCell = `
              <td rowspan="${rowCount}" style="vertical-align: middle; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                <button class="action-btn link" data-head-id="${h.id}">
                  <i class="fas fa-link"></i> ${dictionary[lang].link_members}
                </button>
              </td>
            `;
          }

          allRows += `
            <tr style="border: 1px solid rgba(255,255,255,0.1);">
              ${headCell}
              <td style="text-align: center; border: 1px solid rgba(255,255,255,0.1); width: 35px; font-size: 0.85rem; white-space: normal;">${m ? (m.listNo || "---") : "---"}</td>
              <td style="border: 1px solid rgba(255,255,255,0.1); font-weight: 600;">${m ? m.voterName : `<span style="color:var(--text-muted); font-style:italic; font-weight: normal;">No members linked</span>`}</td>
              <td style="border: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem;">${m ? (m.epicNo || "---") : "---"}</td>
              <td style="text-align: center; border: 1px solid rgba(255,255,255,0.1); width: 50px; font-size: 0.85rem; white-space: normal;">${m ? (m.boothNo || "---") : "---"}</td>
              <td style="text-align: center; border: 1px solid rgba(255,255,255,0.1);">${m ? (m.mobileNo || "---") : "---"}</td>
              <td style="border: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem;">${m ? (m.address || "---") : "---"}</td>
              ${actionCell}
            </tr>
          `;
        }
      });

      refs.familyHeadBody.innerHTML = allRows;

      // Add click events for link buttons
      refs.familyHeadBody.querySelectorAll(".action-btn.link").forEach(btn => {
        btn.onclick = () => openLinkMembersModal(btn.getAttribute("data-head-id"));
      });
    }

    function exportFamilyData() {
      const heads = state.voters.filter(v => v.isFamilyHead);
      const headers = ["Family Head", "Head EPIC", "Head Booth", "Member List No", "Member Name", "Member EPIC", "Member Booth", "Member Mobile", "Member Address"];
      let rows = [];

      heads.forEach(h => {
        const familyMemberIds = h.familyMembers ? Object.keys(h.familyMembers) : [];
        const members = familyMemberIds.map(mid => state.voters.find(v => v.id === mid)).filter(Boolean);

        if (members.length === 0) {
          rows.push([h.voterName, h.epicNo || "", h.boothNo || "", "", "", "", "", "", ""]);
        } else {
          members.forEach(m => {
            rows.push([h.voterName, h.epicNo || "", h.boothNo || "", m.listNo || "", m.voterName, m.epicNo || "", m.boothNo || "", m.mobileNo || "", m.address || ""]);
          });
        }
      });

      const csv = [headers, ...rows].map(row => row.map(value => `"${String(value).replace(/"/g, '""')}"`).join(",")).join("\r\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "family_management_report.csv";
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function openLinkMembersModal(headId) {
      linkingFamilyHeadId = headId;
      selectedFamilyMemberIds.clear();
      const head = state.voters.find(v => v.id === headId);
      if (head && head.familyMembers) {
        Object.keys(head.familyMembers).forEach(mid => selectedFamilyMemberIds.add(mid));
      }
      renderLinkMembersList();
      refs.linkMembersModal.classList.add("visible");
    }

    function renderLinkMembersList() {
      const query = refs.linkMembersSearch.value.trim().toLowerCase();
      // Filter out only voters from the SAME booth as the head (logical family grouping)
      const head = state.voters.find(v => v.id === linkingFamilyHeadId);
      const candidates = state.voters.filter(v => {
        if (v.id === linkingFamilyHeadId) return false;
        if (head && v.boothNo !== head.boothNo) return false;
        if (query && !(v.voterName.toLowerCase().includes(query) || v.epicNo.toLowerCase().includes(query))) return false;
        return true;
      });

      const rows = candidates.map(v => {
        const isSelected = selectedFamilyMemberIds.has(v.id);
        return `
          <tr style="cursor:pointer;" onclick="toggleFamilyMemberSelection('${v.id}')">
            <td style="text-align:center;">
              <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleFamilyMemberSelection('${v.id}')" />
            </td>
            <td>
              <div style="font-weight:600;">${v.voterName}</div>
              <div style="color:var(--accent); font-size:0.8rem;">${v.voterNameMr || ""}</div>
            </td>
            <td>${v.epicNo}</td>
            <td style="font-size:0.8rem;">${v.address || ""}</td>
          </tr>
        `;
      }).join("");
      refs.linkMembersList.innerHTML = rows || `<tr><td colspan="4" style="text-align:center;">No results found in this booth</td></tr>`;
    }

    window.toggleFamilyMemberSelection = (vId) => {
      if (selectedFamilyMemberIds.has(vId)) {
        selectedFamilyMemberIds.delete(vId);
      } else {
        selectedFamilyMemberIds.add(vId);
      }
      renderLinkMembersList();
    };

    window.navigateToFamilyHead = (id) => {
      const navBtn = document.querySelector('button[data-target="familyManagementSection"]');
      if (navBtn) navBtn.click();
    };



    // Set initial value
    if (document.getElementById("langSelect")) {
      document.getElementById("langSelect").value = state.lang;
    }

    function populateDistricts(selectEl) {
      Object.keys(districtTalukaMap).sort().forEach(district => {
        const option = document.createElement("option");
        option.value = district;
        option.textContent = district;
        selectEl.appendChild(option);
      });
    }

    function populateCastes(selectEl) {
      if (!selectEl) return;
      const firstOption = selectEl.options[0];
      const placeholder = (firstOption && firstOption.value === "") ? firstOption : null;
      selectEl.innerHTML = "";
      if (placeholder) {
        if (state.lang === 'mr' && placeholder.getAttribute('data-translate') === 'all_castes') {
          placeholder.textContent = dictionary.mr.all_castes;
        }
        selectEl.appendChild(placeholder);
      }
      casteOptions.forEach(c => {
        const option = document.createElement("option");
        option.value = c;
        const translated = dictionary[state.lang][c];
        option.textContent = translated || c;
        selectEl.appendChild(option);
      });
    }

    populateDistricts(document.getElementById("districtSelect"));
    populateDistricts(refs.filterDistrict);
    populateCastes(document.getElementById("casteSelect"));
    populateCastes(document.getElementById("staffCaste"));
    populateCastes(refs.filterCaste);
    populateCastes(refs.editFields.caste);
    populateCastes(refs.staffEditFields.caste);
    populateCastes(refs.staffFilterCaste);


    function setTalukas(selectEl, district) {
      selectEl.innerHTML = "<option value=''>Select taluka</option>";
      if (!district || !districtTalukaMap[district]) return;
      districtTalukaMap[district].forEach(taluka => {
        const option = document.createElement("option");
        option.value = taluka;
        option.textContent = taluka;
        selectEl.appendChild(option);
      });
    }

    document.getElementById("districtSelect").addEventListener("change", (e) => {
      setTalukas(document.getElementById("talukaSelect"), e.target.value);
    });

    refs.filterDistrict.addEventListener("change", (e) => {
      setTalukas(refs.filterTaluka, e.target.value);
      renderVoterTable();
    });

    [refs.filterTaluka, refs.filterCaste, refs.filterGender, refs.filterVoterType, refs.filterBooth, refs.searchText].forEach(el => {
      el.addEventListener("input", renderVoterTable);
      el.addEventListener("change", renderVoterTable);
    });

    function showToast(message, variant = "success") {
      refs.toast.textContent = message;
      refs.toast.className = `toast show ${variant}`;
      setTimeout(() => refs.toast.className = "toast", 2000);
    }

    function setRole(role, profile) {
      state.role = role;
      state.profile = profile;
      document.body.classList.add("dashboard-active");
      document.body.classList.remove("login-active");
      document.getElementById("landingSection").style.display = "none";
      refs.authSection.style.display = "none";
      refs.dashboard.classList.add("visible");
      refs.signOutBtn.style.display = "inline-flex";
      if (refs.statusBadge) {
        refs.statusBadge.textContent = role === "admin" ? "Admin" : "User";
        refs.statusBadge.style.background = role === "admin" ? "rgba(52, 211, 153, 0.1)" : "var(--accent-soft)";
        refs.statusBadge.style.color = role === "admin" ? "var(--success)" : "var(--accent)";
      }
      const name = profile?.displayName || (role === "admin" ? "Adhikrao Ghadage" : (state.lang === "mr" ? "वापरकर्ता" : "User"));
      refs.welcomeText.textContent = `${dictionary[state.lang].welcome}, ${name}!`;
      applyTranslations();
      toggleAdminSections(role === "admin");
      renderVoterTable();
      renderStaffDirectory();
      if (role === "admin") {
        localStorage.setItem(ADMIN_SESSION_KEY, "true");
        renderUserLogins();
        renderAdmins();
      } else {
        localStorage.removeItem(ADMIN_SESSION_KEY);
        if (profile) saveUserInfo(profile);
      }
    }

    async function saveUserInfo(user) {
      if (!user) return;
      const userRef = ref(db, `users/${user.uid}`);
      const payload = {
        uid: user.uid,
        displayName: user.displayName || "User",
        email: user.email || "No Email",
        photoURL: user.photoURL || "",
        lastLogin: Date.now(),
        status: "Active"
      };
      await update(userRef, payload);
    }

    function resetToGuest() {
      state.role = "guest";
      state.profile = null;
      document.body.classList.add("login-active");
      document.body.classList.remove("dashboard-active");
      refs.authSection.style.display = "none";
      document.getElementById("landingSection").style.display = "block";
      refs.dashboard.classList.remove("visible");
      refs.signOutBtn.style.display = "none";
      if (refs.statusBadge) {
        refs.statusBadge.textContent = "Please Login";
        refs.statusBadge.style.background = "rgba(239, 68, 68, 0.1)";
        refs.statusBadge.style.color = "var(--danger)";
      }
      localStorage.removeItem(ADMIN_SESSION_KEY);
      renderVoterTable();
    }

    function toggleAdminSections(isAdmin) {
      document.querySelectorAll('[data-requires-admin="true"]').forEach(btn => {
        // Special case: Allow users to see Staff Directory nav button, but readonly
        if (btn.dataset.target === "staffDirectorySection") {
          btn.style.display = "";
        } else {
          btn.style.display = isAdmin ? "" : "none";
        }
      });

      // Hide Export Buttons for non-admins
      if (!isAdmin) {
        if (refs.exportStaffDirectory) refs.exportStaffDirectory.style.display = "none";
        if (refs.exportVoterDirectory) refs.exportVoterDirectory.style.display = "none";
      } else {
        if (refs.exportStaffDirectory) refs.exportStaffDirectory.style.display = "inline-flex";
        if (refs.exportVoterDirectory) refs.exportVoterDirectory.style.display = "inline-flex";
        if (document.getElementById("bulkTransliterateBtn")) document.getElementById("bulkTransliterateBtn").style.display = "inline-flex";
        if (document.getElementById("bulkTransliterateStaffBtn")) document.getElementById("bulkTransliterateStaffBtn").style.display = "inline-flex";
      }

      const staffForm = document.getElementById("staffForm");
      const addVoterSection = document.getElementById("addVoterSection");
      const staffSection = document.getElementById("staffSection");

      if (!isAdmin) {
        if (addVoterSection) addVoterSection.style.display = "none";
        if (staffForm) staffForm.style.display = "none";
        // If the user happens to be on an admin-only section, redirect them
        const activePanel = document.querySelector(".panel.active");
        if (activePanel && activePanel.id === "addVoterSection") {
          activePanel.classList.remove("active");
          document.getElementById("overviewSection").classList.add("active");
          document.querySelectorAll(".nav-button").forEach(b => b.classList.toggle("active", b.dataset.target === "overviewSection"));
        }
      } else {
        // Use empty string to let CSS (.panel { display: none; } / .panel.active { display: block; }) handle visibility
        if (addVoterSection) addVoterSection.style.display = "";
        if (staffForm) staffForm.style.display = "block";
      }
    }

    const sidebar = document.querySelector(".sidebar");
    const sidebarOverlay = document.getElementById("sidebarOverlay");

    // Navigation Logic - Re-query to ensure all elements are captured
    const navButtons = document.querySelectorAll(".nav-button");
    const panels = document.querySelectorAll(".panel");

    navButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        if (btn.dataset.requiresAdmin === "true" && state.role !== "admin") {
          // Allow Staff Directory for non-admins (view only)
          if (btn.dataset.target !== "staffDirectorySection") {
            showToast(state.lang === 'mr' ? "ॲडमिन प्रवेश आवश्यक आहे" : "Admin access required", "error");
            return;
          }
        }

        navButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        panels.forEach(panel => {
          panel.classList.remove("active");
          panel.style.display = "none";
        });

        const targetId = btn.dataset.target;
        const target = document.getElementById(targetId);

        if (target) {
          target.classList.add("active");
          target.style.display = "block";

          window.scrollTo(0, 0);
          document.documentElement.scrollTop = 0; // For modern browsers

          // Explicitly call render functions to ensure data is fresh
          if (targetId === "directorySection") {
            console.log("Switching to Directory, rendering...");
            renderVoterTable();
          }
          if (targetId === "staffDirectorySection") renderStaffDirectory();
          if (targetId === "userLoginsSection") renderUserLogins();
          if (targetId === "manageAdminSection") renderAdmins();
          if (targetId === "overviewSection") updateOverview();
          if (targetId === "analyticsSection") renderAnalytics();
          if (targetId === "deceasedListSection") renderDeceasedTable();
          if (targetId === "votedListSection") renderVotedTable();
        }

        // Auto-hide sidebar on selection (especially for mobile)
        if (sidebar && sidebarOverlay) {
          sidebar.classList.remove("open");
          sidebarOverlay.classList.remove("visible");
        }
      });
    });

    // Auth Handlers - Check for Redirect Result on Load
    getRedirectResult(auth).then((result) => {
      if (result) {
        setRole("user", result.user);
        const name = result.user.displayName || 'User';
        showToast(`Welcome ${name} to User Dashboard!`, "success");
      }
    }).catch((error) => {
      console.error("Redirect Login Error:", error);
    });

    document.getElementById("adminLoginForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const email = document.getElementById("adminEmail").value.trim();
      const password = document.getElementById("adminPassword").value.trim();

      // Check hardcoded admin
      if (email === ADMIN_CREDENTIALS.email && password === ADMIN_CREDENTIALS.password) {
        refs.adminStatus.textContent = "";
        setRole("admin", { displayName: ADMIN_CREDENTIALS.displayName, email });
        showToast(`Welcome ${ADMIN_CREDENTIALS.displayName} to Admin Dashboard!`, "success");
        return;
      }

      // Check database admins
      const foundAdmin = state.admins.find(a => a.email === email && a.password === password);
      if (foundAdmin) {
        refs.adminStatus.textContent = "";
        setRole("admin", { displayName: foundAdmin.name, email });
        showToast(`Welcome ${foundAdmin.name} to Admin Dashboard!`, "success");
      } else {
        refs.adminStatus.textContent = "Incorrect credentials";
        showToast("Login failed", "error");
      }
    });

    const googleBtn = document.getElementById("googleSignIn");
    googleBtn.addEventListener("click", async () => {
      try {
        googleBtn.disabled = true;
        // Try Popup First
        await signInWithPopup(auth, provider).then(result => {
          setRole("user", result.user);
          const name = result.user.displayName || 'User';
          showToast(`Welcome ${name} to User Dashboard!`, "success");
        }).catch(err => {
          // If Popup is blocked or fails due to COOP, try Redirect
          if (err.code === "auth/popup-closed-by-user" || err.code === "auth/cancelled-popup-request" || err.message.includes("Cross-Origin-Opener-Policy")) {
            console.log("Switching to Redirect mode...");
            return signInWithRedirect(auth, provider);
          }
          throw err;
        });
      } catch (error) {
        console.error("Login Error:", error);
        showToast(state.lang === 'mr' ? "गुगल साइन-इन अयशस्वी झाले" : "Google sign-in failed", "error");
      } finally {
        googleBtn.disabled = false;
      }
    });

    refs.signOutBtn.addEventListener("click", async () => {
      if (state.role === "admin") {
        resetToGuest();
        showToast("Admin signed out", "success");
      } else {
        await signOut(auth);
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        setRole("user", user);
      } else if (state.role !== "admin") {
        resetToGuest();
      }
    });

    document.getElementById("voterForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const lang = state.lang;
      if (state.role !== "admin") return showToast(lang === 'mr' ? "ॲडमिन प्रवेश आवश्यक आहे" : "Admin access required", "error");
      const payload = {
        boothNo: document.getElementById("boothNo").value,
        listNo: document.getElementById("listNo").value.trim(),
        voterName: document.getElementById("voterName").value.trim(),
        voterNameMr: document.getElementById("voterNameMr").value.trim(),
        epicNo: document.getElementById("epicNo").value.trim().toUpperCase(),
        mobileNo: document.getElementById("mobileNo").value.trim(),
        district: document.getElementById("districtSelect").value,
        taluka: document.getElementById("talukaSelect").value,
        gender: document.getElementById("genderSelect").value,
        voterType: document.getElementById("voterType").value,
        caste: document.getElementById("casteSelect").value,
        village: document.getElementById("villageName").value.trim(),
        address: document.getElementById("address").value.trim(),
        isFamilyHead: document.getElementById("isFamilyHead").checked,
        createdAt: Date.now()
      };
      try {
        await push(ref(db, "voters"), payload);
        (e.target).reset();
        setTalukas(document.getElementById("talukaSelect"), "");
        showToast(lang === 'mr' ? "मतदार जतन केला" : "Voter saved", "success");
      } catch (error) {
        console.error(error);
        showToast(lang === 'mr' ? "मतदार जतन करण्यात अयशस्वी" : "Failed to save voter", "error");
      }
    });

    document.getElementById("staffForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const lang = state.lang;
      if (state.role !== "admin") return showToast(lang === 'mr' ? "ॲडमिन प्रवेश आवश्यक आहे" : "Admin access required", "error");
      const payload = {
        village: "Raygaon",
        name: document.getElementById("staffName").value.trim(),
        nameMr: document.getElementById("staffNameMr").value.trim(),
        boothNo: document.getElementById("staffBooth").value,
        caste: document.getElementById("staffCaste").value.trim(),
        casteMr: document.getElementById("staffCasteMr").value.trim(),
        designation: document.getElementById("staffDesignation").value.trim(),
        designationMr: document.getElementById("staffDesignationMr").value.trim(),
        workplace: document.getElementById("staffCollege").value.trim(),
        workplaceMr: document.getElementById("staffCollegeMr").value.trim(),
        mobile: document.getElementById("staffMobile").value.trim(),
        houseVoters: Number(document.getElementById("staffHouseCount").value || 0),
        createdAt: Date.now()
      };
      try {
        await push(ref(db, "staff"), payload);
        (e.target).reset();
        showToast(lang === 'mr' ? "कर्मचारी माहिती जतन केली" : "Staff saved", "success");
      } catch (error) {
        console.error(error);
        showToast(lang === 'mr' ? "कर्मचारी माहिती जतन करण्यात अयशस्वी" : "Failed to save staff record", "error");
      }
    });

    refs.voterSampleBtn.addEventListener("click", () => {
      downloadSampleCSV("voter-import-sample.csv", voterSampleData);
    });

    refs.staffSampleBtn.addEventListener("click", () => {
      downloadSampleCSV("staff-import-sample.csv", staffSampleData);
    });

    refs.voterTableBody.addEventListener("click", (event) => {
      const target = event.target.closest("button");
      if (!target) return;
      const action = target.dataset.action;
      const id = target.dataset.id;
      if (!action || !id) return;

      const voter = state.voters.find(v => v.id === id);
      if (!voter) return;

      if (action === "print") {
        printVoterSlip(voter);
        return;
      }

      if (action === "mark-voted") {
        markAsVoted(id);
        return;
      }

      if (action === "unmark-voted") {
        unmarkAsVoted(id);
        return;
      }

      if (state.role !== "admin") {
        showToast("Admin access required", "error");
        return;
      }

      if (action === "edit") {
        openEditModal(voter);
      } else if (action === "mark-deceased") {
        markAsDeceased(id);
      } else if (action === "delete") {
        const confirmed = confirm(`Delete voter ${voter.voterName}?`);
        if (!confirmed) return;
        remove(ref(db, `voters/${id}`))
          .then(() => showToast("Voter deleted", "success"))
          .catch(err => {
            console.error(err);
            showToast("Failed to delete voter", "error");
          });
      }
    });

    function openEditModal(voter) {
      editingVoterId = voter.id;
      const f = refs.editFields;
      f.listNo.value = voter.listNo || "";
      f.boothNo.value = voter.boothNo || "";
      f.voterName.value = voter.voterName || "";
      f.voterNameMr.value = voter.voterNameMr || "";
      f.epicNo.value = voter.epicNo || "";
      f.mobileNo.value = voter.mobileNo || "";
      f.district.value = voter.district || "";
      f.taluka.value = voter.taluka || "";
      f.gender.value = voter.gender || "";
      f.voterType.value = voter.voterType || "";
      if (voter.caste) {
        const casteMatch = casteOptions.find(c => c.toUpperCase() === voter.caste.toUpperCase());
        f.caste.value = casteMatch || "";
      } else {
        f.caste.value = "";
      }
      f.village.value = voter.village || "";
      f.address.value = voter.address || "";
      f.isFamilyHead.checked = !!voter.isFamilyHead;
      refs.editModal.classList.add("visible");
    }

    function closeEditModal() {
      refs.editModal.classList.remove("visible");
      refs.editForm.reset();
      editingVoterId = null;
    }

    refs.editModalClose.addEventListener("click", closeEditModal);
    refs.editModalCancel.addEventListener("click", closeEditModal);
    window.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && refs.editModal.classList.contains("visible")) {
        closeEditModal();
      }
    });

    refs.editForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!editingVoterId) return;
      if (state.role !== "admin") {
        showToast("Admin access required", "error");
        return;
      }
      const payload = {
        listNo: refs.editFields.listNo.value.trim(),
        boothNo: refs.editFields.boothNo.value.trim(),
        voterName: refs.editFields.voterName.value.trim(),
        voterNameMr: refs.editFields.voterNameMr.value.trim(),
        epicNo: refs.editFields.epicNo.value.trim().toUpperCase(),
        mobileNo: refs.editFields.mobileNo.value.trim(),
        district: refs.editFields.district.value.trim(),
        taluka: refs.editFields.taluka.value.trim(),
        gender: refs.editFields.gender.value.trim(),
        voterType: refs.editFields.voterType.value,
        caste: refs.editFields.caste.value.trim(),
        village: refs.editFields.village.value.trim(),
        address: refs.editFields.address.value.trim(),
        isFamilyHead: refs.editFields.isFamilyHead.checked
      };
      try {
        await update(ref(db, `voters/${editingVoterId}`), payload);
        showToast("Voter updated", "success");
        closeEditModal();
      } catch (error) {
        console.error(error);
        showToast("Failed to update voter", "error");
      }
    });

    if (refs.exportVotedList) {
      refs.exportVotedList.addEventListener("click", exportVotedList);
    }

    if (refs.printVotedList) {
      refs.printVotedList.addEventListener("click", () => {
        const voted = state.voters.filter(v => v.isVoted);
        if (!voted.length) {
          showToast(state.lang === 'mr' ? "माहिती उपलब्ध नाही" : "No data to print", "error");
          return;
        }
        printVotersList(dictionary[state.lang].voted_list_title || "Voted List", voted);
      });
    }

    refs.voterImportInput.addEventListener("change", (event) => {
      handleCSVImport(event.target.files?.[0], "voter");
      event.target.value = "";
    });

    refs.staffImportInput.addEventListener("change", (event) => {
      handleCSVImport(event.target.files?.[0], "staff");
      event.target.value = "";
    });

    refs.filterCaste.addEventListener("change", renderVoterTable);
    refs.filterGender.addEventListener("change", renderVoterTable);
    refs.filterVoterType.addEventListener("change", renderVoterTable);
    refs.searchText.addEventListener("input", renderVoterTable);
    refs.staffFilterBooth.addEventListener("change", renderStaffDirectory);
    refs.staffFilterCaste.addEventListener("change", renderStaffDirectory);
    refs.staffSearchText.addEventListener("input", renderStaffDirectory);
    refs.exportStaffDirectory.addEventListener("click", exportStaffDirectory);
    refs.exportVoterDirectory.addEventListener("click", exportVoterDirectory);

    // --- Automatic English to Marathi Transliteration ---
    async function transliterateToMarathi(text, targetEl) {
      if (!text || text.length < 2) return;
      try {
        const url = `https://inputtools.google.com/request?text=${encodeURIComponent(text)}&itc=mr-t-i0-und&num=1&cp=0&cs=1&ie=utf-8&oe=utf-8&app=demopage`;
        const res = await fetch(url);
        const data = await res.json();
        if (data && data[0] === "SUCCESS" && data[1][0][1][0]) {
          targetEl.value = data[1][0][1][0];
        }
      } catch (err) {
        console.error("Transliteration error:", err);
      }
    }

    function setupTransliteration(sourceId, targetId) {
      const source = document.getElementById(sourceId);
      const target = document.getElementById(targetId);
      if (!source || !target) return;
      let translitTimeout;
      source.addEventListener("input", () => {
        clearTimeout(translitTimeout);
        translitTimeout = setTimeout(() => {
          transliterateToMarathi(source.value, target);
        }, 1000); // 1 second debounce
      });
    }

    setupTransliteration("voterName", "voterNameMr");
    setupTransliteration("editVoterName", "editVoterNameMr");

    // Staff Transliterations
    setupTransliteration("staffName", "staffNameMr");
    setupTransliteration("staffCaste", "staffCasteMr");
    setupTransliteration("staffDesignation", "staffDesignationMr");
    setupTransliteration("staffCollege", "staffCollegeMr");

    setupTransliteration("editStaffName", "editStaffNameMr");
    setupTransliteration("editStaffCaste", "editStaffCasteMr");
    setupTransliteration("editStaffDesignation", "editStaffDesignationMr");
    setupTransliteration("editStaffWorkplace", "editStaffWorkplaceMr");

    // Toggle Group Click Handlers
    document.getElementById("familyHeadToggleGroup")?.addEventListener("click", (e) => {
      if (e.target.tagName !== 'INPUT') {
        const checkbox = document.getElementById("isFamilyHead");
        if (checkbox) checkbox.checked = !checkbox.checked;
      }
    });
    document.getElementById("editFamilyHeadToggleGroup")?.addEventListener("click", (e) => {
      if (e.target.tagName !== 'INPUT') {
        const checkbox = document.getElementById("editIsFamilyHead");
        if (checkbox) checkbox.checked = !checkbox.checked;
      }
    });

    async function getMarathiText(text) {
      if (!text || text.length < 2) return text;
      const cleanText = text.trim();
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);
      try {
        const url = `https://inputtools.google.com/request?text=${encodeURIComponent(cleanText)}&itc=mr-t-i0-und&num=1&cp=0&cs=1&ie=utf-8&oe=utf-8&app=demopage`;
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error("Network response was not ok");
        const data = await res.json();
        if (data && data[0] === "SUCCESS" && data[1] && data[1][0] && data[1][0][1] && data[1][0][1][0]) {
          return data[1][0][1][0].trim();
        }
      } catch (err) {
        if (err.name === 'AbortError') {
          console.warn("Transliteration API timed out for:", cleanText);
        } else {
          console.error("Transliteration API failed for:", cleanText, err);
        }
      } finally {
        clearTimeout(timeoutId);
      }
      return text;
    }

    const fixSangli = async () => {
      if (!state.voters || state.voters.length === 0) return;
      const votersToFix = state.voters.filter(v => v.district && v.district.trim().toUpperCase() === "SANGALI");
      if (votersToFix.length === 0) return;

      console.log(`Fixing ${votersToFix.length} records with district SANGALI...`);
      let fixes = {};
      votersToFix.forEach(v => {
        fixes[`voters/${v.id}/district`] = "SANGLI";
      });
      try {
        await update(ref(db), fixes);
        showToast(`Fixed ${votersToFix.length} Sangli records`, "info");
      } catch (err) {
        console.error("Failed to fix Sangli records:", err);
      }
    };

    document.getElementById("bulkTransliterateBtn").addEventListener("click", async () => {
      console.log("Bulk transliterate button clicked. Checking voters...");
      const voters = state.voters.filter(v => {
        if (!v.voterNameMr || v.voterNameMr.trim() === "") return true;
        if (v.district && (!v.districtMr || v.districtMr.trim() === "")) return true;
        if (v.taluka && (!v.talukaMr || v.talukaMr.trim() === "")) return true;
        if (v.caste && (!v.casteMr || v.casteMr.trim() === "")) return true;
        if (v.address && (!v.addressMr || v.addressMr.trim() === "")) return true;
        if (v.gender && (!v.genderMr || v.genderMr.trim() === "")) return true;
        return false;
      });
      const total = voters.length;
      console.log("Found voters to convert:", total);

      if (total === 0) {
        alert("All voters already have Marathi details!");
        return;
      }


      console.log("Starting transliteration process...");

      const btn = document.getElementById("bulkTransliterateBtn");
      btn.disabled = true;

      let count = 0;
      let batchUpdates = {};
      const batchSize = 50;

      for (let i = 0; i < total; i++) {
        const voter = voters[i];
        console.log(`Processing voter ${i + 1}/${total}: ${voter.voterName}`);
        const mrName = await getMarathiText(voter.voterName);

        if (mrName && mrName !== voter.voterName) {
          batchUpdates[`voters/${voter.id}/voterNameMr`] = mrName;
          count++;
          console.log(`  - Found Marathi name for ${voter.voterName}: ${mrName}`);
        } else {
          console.log(`  - No new Marathi name for ${voter.voterName} or already exists.`);
        }

        // Show Progress
        const currentProgress = i + 1;
        const percent = Math.round((currentProgress / total) * 100);
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Converting ${currentProgress}/${total} (${percent}%)`;

        // Commit batch every batchSize or at the end
        if (Object.keys(batchUpdates).length >= batchSize || i === total - 1) {
          if (Object.keys(batchUpdates).length > 0) {
            console.log(`Committing batch of ${Object.keys(batchUpdates).length} updates.`);
            try {
              await update(ref(db), batchUpdates);
              console.log("Batch committed successfully.");
              batchUpdates = {}; // reset
            } catch (err) {
              console.error("Batch update failed:", err);
              showToast("Failed to save a batch of updates", "error");
            }
          }
        }

        // Delay to prevent API rate limit (200ms)
        await new Promise(r => setTimeout(r, 200));

        // --- NEW: Transliterate other fields (District, Taluka, Caste, Address, Gender) ---
        // District
        if (voter.district && (!voter.districtMr || voter.districtMr.trim() === "")) {
          const mr = await getMarathiText(voter.district);
          if (mr && mr !== voter.district) batchUpdates[`voters/${voter.id}/districtMr`] = mr;
        }
        // Taluka
        if (voter.taluka && (!voter.talukaMr || voter.talukaMr.trim() === "")) {
          const mr = await getMarathiText(voter.taluka);
          if (mr && mr !== voter.taluka) batchUpdates[`voters/${voter.id}/talukaMr`] = mr;
        }
        // Caste
        if (voter.caste && (!voter.casteMr || voter.casteMr.trim() === "")) {
          const mr = await getMarathiText(voter.caste);
          if (mr && mr !== voter.caste) batchUpdates[`voters/${voter.id}/casteMr`] = mr;
        }
        // Address
        if (voter.address && (!voter.addressMr || voter.addressMr.trim() === "")) {
          const mr = await getMarathiText(voter.address);
          if (mr && mr !== voter.address) batchUpdates[`voters/${voter.id}/addressMr`] = mr;
        }
        // Gender (Map, no API needed usually, but consistent storage helps)
        if (voter.gender && (!voter.genderMr || voter.genderMr.trim() === "")) {
          const gMap = { "Male": "पुरुष", "Female": "महिला", "Other": "इतर" };
          const mr = gMap[voter.gender] || voter.gender;
          batchUpdates[`voters/${voter.id}/genderMr`] = mr;
        }

      }

      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-sync-alt"></i> Convert All to Marathi';
      const msg = `Successfully processed all voters. Transliterated ${count} names!`;
      showToast(msg, "success");
      alert(msg);
    });

    document.getElementById("bulkTransliterateStaffBtn").addEventListener("click", async () => {
      console.log("Starting Staff Conversion...");

      const list = state.staff.filter(s => {
        if (!s) return false;
        return (!s.nameMr || s.nameMr.trim() === "") || (!s.designationMr || s.designationMr.trim() === "") || (!s.casteMr || s.casteMr.trim() === "") || (!s.workplaceMr || s.workplaceMr.trim() === "");
      });

      const total = list.length;
      if (total === 0) {
        alert("All staff records already have Marathi details!");
        return;
      }

      const btn = document.getElementById("bulkTransliterateStaffBtn");
      btn.disabled = true;

      let batchUpdates = {};
      let processedCount = 0;

      for (let i = 0; i < total; i++) {
        const s = list[i];
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${i + 1}/${total}`;

        try {
          // Name
          if (s.name && (!s.nameMr || s.nameMr.trim() === "")) {
            const mrName = await getMarathiText(s.name);
            if (mrName && mrName.toLowerCase() !== s.name.toLowerCase()) {
              batchUpdates[`staff/${s.id}/nameMr`] = mrName;
            }
          }

          // Designation
          if (s.designation && (!s.designationMr || s.designationMr.trim() === "")) {
            const mrDes = await getMarathiText(s.designation);
            if (mrDes && mrDes.toLowerCase() !== (s.designation || "").toLowerCase()) {
              batchUpdates[`staff/${s.id}/designationMr`] = mrDes;
            }
          }

          // Caste
          if (s.caste && (!s.casteMr || s.casteMr.trim() === "")) {
            const mrCaste = await getMarathiText(s.caste);
            if (mrCaste && mrCaste.toLowerCase() !== (s.caste || "").toLowerCase()) {
              batchUpdates[`staff/${s.id}/casteMr`] = mrCaste;
            }
          }

          // Workplace
          if (s.workplace && (!s.workplaceMr || s.workplaceMr.trim() === "")) {
            const mrWork = await getMarathiText(s.workplace);
            if (mrWork && mrWork.toLowerCase() !== (s.workplace || "").toLowerCase()) {
              batchUpdates[`staff/${s.id}/workplaceMr`] = mrWork;
            }
          }

          processedCount++;

          // Commit every 10 records or at the end
          if (Object.keys(batchUpdates).length >= 10 || i === total - 1) {
            if (Object.keys(batchUpdates).length > 0) {
              await update(ref(db), batchUpdates);
              batchUpdates = {}; // reset
            }
          }
        } catch (err) {
          console.error("Record failed:", s.name, err);
        }

        // Small delay to be safe
        await new Promise(r => setTimeout(r, 150));
      }

      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-sync-alt"></i> Convert Staff to Marathi';
      alert(`Success! Processed ${processedCount} staff records.`);
      showToast("Conversion complete!", "success");
    });

    // --- Assign Voters Feature Logic ---
    const assignRefs = {
      modal: document.getElementById("assignVotersModal"),
      close: document.getElementById("assignVotersClose"),
      cancel: document.getElementById("assignVotersCancel"),
      save: document.getElementById("assignVotersSave"),
      exportBtn: document.getElementById("assignVotersExport"),
      search: document.getElementById("assignVotersSearch"),
      list: document.getElementById("assignVotersList"),
      count: document.getElementById("assignVotersCount"),
    };

    let currentAssignStaffId = null;
    let currentlyAssignedVoters = new Set(); // Set of Voter IDs
    let currentAssignFilter = "all"; // all, assigned, unassigned

    function openAssignVotersModal(staff) {
      currentAssignStaffId = staff.id;
      currentlyAssignedVoters = new Set(staff.assignedVoters || []);
      currentAssignFilter = "unassigned";

      // Reset filter UI
      document.querySelectorAll("[data-assign-filter]").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.assignFilter === "unassigned");
      });

      // Show/Hide Save Button for Admin
      assignRefs.save.style.display = state.role === "admin" ? "block" : "none";

      assignRefs.modal.classList.add("visible");

      renderAssignVotersList();
    }

    function closeAssignVotersModal() {
      assignRefs.modal.classList.remove("visible");
      currentAssignStaffId = null;
      currentlyAssignedVoters.clear();
      assignRefs.search.value = "";
    }

    assignRefs.close.addEventListener("click", closeAssignVotersModal);
    assignRefs.cancel.addEventListener("click", closeAssignVotersModal);
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && assignRefs.modal.classList.contains("visible")) closeAssignVotersModal();
    });

    assignRefs.search.addEventListener("input", renderAssignVotersList);

    function renderAssignVotersList() {
      const query = assignRefs.search.value.trim().toLowerCase();
      const voters = state.voters;
      let filtered = voters;

      // Filtering by Search Query
      if (query) {
        filtered = filtered.filter(v =>
          (v.voterName || "").toLowerCase().includes(query) ||
          (v.voterNameMr || "").toLowerCase().includes(query) ||
          (v.epicNo || "").toLowerCase().includes(query)
        );
      }

      // Filtering by Tab (Assigned/Unassigned)
      if (currentAssignFilter === "assigned") {
        filtered = filtered.filter(v => currentlyAssignedVoters.has(v.id));
      } else if (currentAssignFilter === "unassigned") {
        filtered = filtered.filter(v => !currentlyAssignedVoters.has(v.id));
      }

      // Sort: Selected first, then Alphabetical
      filtered.sort((a, b) => {
        const aSel = currentlyAssignedVoters.has(a.id);
        const bSel = currentlyAssignedVoters.has(b.id);
        if (aSel && !bSel) return -1;
        if (!aSel && bSel) return 1;
        return (a.voterName || "").localeCompare(b.voterName || "");
      });

      const count = currentlyAssignedVoters.size;
      assignRefs.count.textContent = `Selected: ${count}`;

      // Render limit to improve performance if list is huge
      const renderLimit = 200;
      const displaySet = filtered.slice(0, renderLimit);

      assignRefs.list.innerHTML = displaySet.map(v => {
        const isSelected = currentlyAssignedVoters.has(v.id);
        const rowStyle = isSelected ? "background: rgba(16, 185, 129, 0.1);" : "";
        return `
          <tr style="${rowStyle}">
            <td style="text-align: center;">
               <input type="checkbox" class="assign-checkbox" data-id="${v.id}" ${isSelected ? "checked" : ""} style="transform: scale(1.2); cursor: pointer;" />
            </td>
            <td>${v.voterName || ""}<br><small style="color:var(--text-muted)">${v.voterNameMr || ""}</small></td>
            <td>${v.epicNo || ""}</td>
            <td>${v.boothNo || ""}</td>
            <td style="font-size: 0.85rem;">${v.address || ""}</td>
          </tr>
          `;
      }).join("");

      if (filtered.length > renderLimit) {
        assignRefs.list.innerHTML += `<tr><td colspan="5" style="text-align:center; color: var(--text-muted);">...and ${filtered.length - renderLimit} more keys. Search to find specific voters.</td></tr>`;
      }
    }

    // Event Delegation for Checkboxes
    assignRefs.list.addEventListener("click", (e) => {
      if (e.target.classList.contains("assign-checkbox")) {
        if (state.role !== "admin") {
          e.preventDefault();
          showToast("View Only: Admin access required to change assignments", "info");
          return;
        }
      }
    });

    assignRefs.list.addEventListener("change", (e) => {
      if (e.target.classList.contains("assign-checkbox")) {
        const id = e.target.dataset.id;
        const row = e.target.closest("tr");
        if (e.target.checked) {
          currentlyAssignedVoters.add(id);
          if (row) row.style.background = "rgba(16, 185, 129, 0.1)";
        } else {
          currentlyAssignedVoters.delete(id);
          if (row) row.style.background = "";
        }
        assignRefs.count.textContent = `Selected: ${currentlyAssignedVoters.size}`;
      }
    });

    // Assign Filter Buttons
    document.querySelectorAll("[data-assign-filter]").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("[data-assign-filter]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentAssignFilter = btn.dataset.assignFilter;
        renderAssignVotersList();
      });
    });

    assignRefs.exportBtn.addEventListener("click", () => {
      if (!currentlyAssignedVoters.size) {
        showToast("No voters selected to export", "error");
        return;
      }

      const votersToExport = state.voters.filter(v => currentlyAssignedVoters.has(v.id));
      const headers = ["List No.", "Name (EN)", "Name (MR)", "EPIC", "Booth", "District", "Taluka", "Caste", "Gender", "Mobile", "Address"];

      const rows = votersToExport.map(v => [
        v.listNo || "",
        v.voterName || "",
        v.voterNameMr || "",
        v.epicNo || "",
        v.boothNo || "",
        v.district || "",
        v.taluka || "",
        v.caste || "",
        v.gender || "",
        v.mobileNo || "",
        v.address || ""
      ]);

      const csv = [headers, ...rows].map(row => row.map(value => {
        const safe = `${value}`.replace(/"/g, '""');
        return `"${safe}"`;
      }).join(",")).join("\r\n");

      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `assigned-voters-${currentAssignStaffId}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);
      showToast(`Exported ${votersToExport.length} assigned voters`, "success");
    });

    assignRefs.save.addEventListener("click", async () => {
      if (!currentAssignStaffId) return;

      const staffRef = ref(db, `staff/${currentAssignStaffId}`);
      const assignedArray = Array.from(currentlyAssignedVoters);

      try {
        await update(staffRef, {
          assignedVoters: assignedArray
        });
        showToast(`Assigned ${assignedArray.length} voters successfully!`, "success");
        closeAssignVotersModal();
      } catch (err) {
        console.error(err);
        showToast("Failed to save assignments", "error");
      }
    });

    refs.createAdminForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (state.role !== "admin") return showToast("Admin access required", "error");
      const name = document.getElementById("newAdminName").value.trim();
      const email = document.getElementById("newAdminEmail").value.trim();
      const password = document.getElementById("newAdminPassword").value.trim();

      if (state.admins.some(a => a.email === email)) {
        return showToast("This email is already an admin", "error");
      }

      const payload = {
        name,
        email,
        password,
        createdAt: Date.now()
      };

      try {
        await push(ref(db, "admins"), payload);
        refs.createAdminForm.reset();
        showToast("New admin created!", "success");
      } catch (err) {
        console.error(err);
        showToast("Failed to create admin", "error");
      }
    });

    refs.adminListBody.addEventListener("click", async (e) => {
      const btn = e.target.closest(".delete");
      if (!btn) return;
      const id = btn.dataset.id;
      if (confirm("Are you sure you want to remove this admin?")) {
        try {
          await remove(ref(db, `admins/${id}`));
          showToast("Admin removed", "success");
        } catch (err) {
          showToast("Failed to remove admin", "error");
        }
      }
    });

    refs.staffDirectoryBody.addEventListener("click", (event) => {
      // Check for assign-voters button first
      const assignBtn = event.target.closest("button[data-staff-action='assign-voters']");
      if (assignBtn) {
        if (state.role !== "admin") {
          showToast("Admin access required", "error");
          return;
        }
        const id = assignBtn.dataset.id;
        const staffMember = state.staff.find(s => s.id === id);
        if (staffMember) openAssignVotersModal(staffMember);
        return;
      }

      const button = event.target.closest?.("button[data-staff-action]");
      if (!button) return;
      const { staffAction, id } = button.dataset;
      if (!staffAction || !id) return;
      if (state.role !== "admin") {
        showToast("Admin access required", "error");
        return;
      }
      const staffMember = state.staff.find(s => s.id === id);
      if (!staffMember) return;
      if (staffAction === "edit") {
        openStaffModal(staffMember);
      } else if (staffAction === "delete") {
        const confirmed = confirm(`Delete staff member ${staffMember.name}?`);
        if (!confirmed) return;
        remove(ref(db, `staff/${id}`))
          .then(() => showToast("Staff deleted", "success"))
          .catch(err => {
            console.error(err);
            showToast("Failed to delete staff", "error");
          });
      }
    });

    // Analytics State
    let currentAnalyticsTab = "boothNo"; // boothNo, caste, gender, district

    // Analytics Tab Switching
    const analyticsTabs = document.querySelectorAll("[data-analytics-tab]");
    analyticsTabs.forEach(tab => {
      tab.addEventListener("click", () => {
        analyticsTabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        currentAnalyticsTab = tab.dataset.analyticsTab;
        renderAnalytics();
      });
    });

    function renderAnalytics() {
      const tbody = document.getElementById("analyticsBody");
      if (!tbody) return;

      const lang = state.lang;
      const headerMap = {
        "boothNo": lang === "mr" ? "बुथ क्रमांक" : "Booth Number",
        "caste": lang === "mr" ? "जात वर्गवारी" : "Caste Category",
        "gender": lang === "mr" ? "लिंग" : "Gender",
        "district": lang === "mr" ? "जिल्हा" : "District"
      };
      document.getElementById("analyticsCategoryHeader").textContent = headerMap[currentAnalyticsTab];

      if (!state.voters.length) {
        tbody.innerHTML = `<tr><td colspan='6'>${dictionary[lang].loading_analytics}</td></tr>`;
        return;
      }

      const map = new Map();
      let grandTotal = { total: 0, male: 0, female: 0, other: 0 };

      state.voters.forEach(voter => {
        let val = voter[currentAnalyticsTab] || "Unassigned";
        let key = val.toString().trim();

        // Normalizing Case
        if (currentAnalyticsTab !== "boothNo" && key !== "Unassigned") {
          key = key.toUpperCase();
        }
        if (currentAnalyticsTab === "boothNo" && !voter.boothNo) key = "Unassigned";

        if (!map.has(key)) {
          map.set(key, { total: 0, male: 0, female: 0, other: 0 });
        }
        const bucket = map.get(key);
        bucket.total += 1;
        grandTotal.total += 1;

        const g = (voter.gender || "").toString().trim().toLowerCase();
        if (g === "male") {
          bucket.male += 1;
          grandTotal.male += 1;
        } else if (g === "female") {
          bucket.female += 1;
          grandTotal.female += 1;
        } else {
          bucket.other += 1;
          grandTotal.other += 1;
        }
      });

      const sortedEntries = Array.from(map.entries()).sort((a, b) => a[0].localeCompare(b[0], undefined, { numeric: true }));

      let rowsHtml = sortedEntries.map(([label, data]) => {
        let displayLabel = label;
        if (currentAnalyticsTab === "gender") {
          if (label === "MALE") displayLabel = dictionary[lang].male_header || "MALE";
          if (label === "FEMALE") displayLabel = dictionary[lang].female_header || "FEMALE";
        } else if (currentAnalyticsTab === "caste") {
          const mrName = dictionary['mr'][label?.toUpperCase()];
          displayLabel = `<div>${label}</div><div style="color: var(--accent); font-size: 0.8rem; font-weight: normal;">${mrName || ""}</div>`;
        }

        let actionButtons = `
          <button class="action-btn edit" data-group-key="${label}" data-action="view-group" title="View Group">
             <i class="fas fa-eye"></i> ${lang === 'mr' ? 'पाहणे' : 'VIEW'}
          </button>
          <button class="action-btn" data-group-key="${label}" data-action="export-group" title="Export All">
             <i class="fas fa-file-export"></i> ${lang === 'mr' ? 'एक्सपोर्ट' : 'EXPORT'}
          </button>
        `;

        return `
        <tr>
          <td>${displayLabel}</td>
          <td style="color: white;" data-action="view-group" data-group-key="${label}">${data.total}</td>
          <td style="color: var(--primary);" data-action="view-group" data-group-key="${label}" data-gender="male">${data.male}</td>
          <td style="color: #f472b6;" data-action="view-group" data-group-key="${label}" data-gender="female">${data.female}</td>
          <td style="color: var(--text-muted); opacity: 0.6;">${data.other}</td>
          <td>
            <div class="table-actions">
              ${actionButtons}
            </div>
          </td>
        </tr>`;
      }).join("");

      // Add Grand Total Row
      const totalLabel = lang === 'mr' ? 'एकूण (GRAND TOTAL)' : 'GRAND TOTAL';
      const totalRow = `
        <tr class="grand-total-row">
          <td>${totalLabel}</td>
          <td>${grandTotal.total}</td>
          <td>${grandTotal.male}</td>
          <td>${grandTotal.female}</td>
          <td>${grandTotal.other}</td>
          <td></td>
        </tr>
      `;

      tbody.innerHTML = rowsHtml + totalRow;
    }

    refs.analyticsSection?.addEventListener("click", (event) => {
      const actionBtn = event.target.closest?.("[data-action]");
      if (!actionBtn) return;

      const groupKey = actionBtn.dataset.groupKey;
      if (!groupKey) return;

      const genderFilter = actionBtn.dataset.gender; // male or female

      // Filter based on current tab logic
      let voters = state.voters.filter(v => {
        let val = v[currentAnalyticsTab] || "Unassigned";
        if (currentAnalyticsTab === "boothNo" && !v.boothNo) val = "Unassigned";

        if (currentAnalyticsTab !== "boothNo" && val !== "Unassigned") {
          return val.toString().toUpperCase() === groupKey.toUpperCase();
        }
        return val.toString() === groupKey.toString();
      });

      if (genderFilter) {
        voters = voters.filter(v => (v.gender || "").toLowerCase() === genderFilter.toLowerCase());
      }

      if (!voters.length) {
        showToast("No voters in this category", "error");
        return;
      }

      if (actionBtn.dataset.action === "view-group") {
        let displayGroupLabel = groupKey;
        if (currentAnalyticsTab === "gender") {
          displayGroupLabel = (groupKey === "MALE" ? (dictionary[state.lang].male_header || "MALE") : (groupKey === "FEMALE" ? (dictionary[state.lang].female_header || "FEMALE") : groupKey));
        }

        let labelText = (currentAnalyticsTab === "boothNo" ? `BOOTH: ${groupKey}` : `${currentAnalyticsTab.toUpperCase()}: ${displayGroupLabel}`);
        if (genderFilter) {
          const gLabel = genderFilter.toUpperCase() === "MALE" ? (dictionary[state.lang].male_header || "MALE") : (dictionary[state.lang].female_header || "FEMALE");
          labelText += ` (${gLabel})`;
        }
        analyticsFilterMeta = { label: labelText, voters };
        refs.analyticsModalChip.textContent = labelText;
        refs.analyticsModalTitle.textContent = `Voters List`;

        refs.analyticsList.innerHTML = voters.map(v => {
          const actions = state.role === "admin"
            ? `<div class="table-actions">
                <button class="action-btn edit" data-action="edit" data-id="${v.id}">Edit</button>
                <button class="action-btn delete" data-action="delete" data-id="${v.id}">Delete</button>
              </div>`
            : "<span style='color:var(--muted);'>Read-only</span>";

          return `
          <tr>
            <td>${(v.listNo || "").toString().toUpperCase()}</td>
            <td>
              <div style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                ${(v.voterName || "").toUpperCase()}
                ${v.isFamilyHead ? `<span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 1px 4px; border-radius: 4px; text-transform: uppercase;">${state.lang === 'mr' ? 'प्रमुख' : 'HEAD'}</span>` : ''}
              </div>
              <small style="color:var(--text-muted)">${v.voterNameMr || ""}</small>
            </td>
            <td>${(v.epicNo || "").toUpperCase()}</td>
            <td>${(v.boothNo || "").toString().toUpperCase()}</td>
            <td>${(v.district || "").toUpperCase()}</td>
            <td>${(v.taluka || "").toUpperCase()}</td>
            <td>
              <div>${(v.caste || "").toUpperCase()}</div>
              <div style="color: var(--accent); font-size: 0.8rem;">${dictionary['mr'][v.caste?.toUpperCase()] || v.casteMr || ""}</div>
            </td>
            <td>${(v.gender || "").toUpperCase()}</td>
            <td>${(v.mobileNo || "").toUpperCase()}</td>
            <td>${(v.address || "").toUpperCase()}</td>
            <td>${actions}</td>
          </tr>`;
        }).join("");
        refs.analyticsModal.classList.add("visible");
      } else if (actionBtn.dataset.action.startsWith("export-group")) {
        const actionType = actionBtn.dataset.action;
        let exportVoters = voters;
        let suffix = "";

        if (actionType === "export-group-male") {
          exportVoters = voters.filter(v => (v.gender || "").toLowerCase() === "male");
          suffix = "-MALE";
        } else if (actionType === "export-group-female") {
          exportVoters = voters.filter(v => (v.gender || "").toLowerCase() === "female");
          suffix = "-FEMALE";
        }

        if (!exportVoters.length) {
          showToast("No data for this specific gender in this group", "error");
          return;
        }

        const headers = ["List No.", "Name (EN)", "Name (MR)", "EPIC", "Booth", "District", "Taluka", "Caste", "Gender", "Mobile", "Address"];
        const rows = exportVoters.map(v => [
          (v.listNo || "").toString().toUpperCase(),
          (v.voterName || "").toUpperCase(),
          (v.voterNameMr || ""),
          (v.epicNo || "").toUpperCase(),
          (v.boothNo || "").toString().toUpperCase(),
          (v.district || "").toUpperCase(),
          (v.taluka || "").toUpperCase(),
          (v.caste || "").toUpperCase(),
          (v.gender || "").toUpperCase(),
          (v.mobileNo || "").toUpperCase(),
          (v.address || "").toUpperCase()
        ]);
        const csv = [headers, ...rows].map(row => row.map(value => `"${`${value}`.replace(/"/g, '""')}"`).join(",")).join("\r\n");
        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `analytics-${currentAnalyticsTab}-${groupKey}${suffix}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);
        showToast(`Exported ${groupKey} ${suffix.replace("-", "")} list`, "success");
      }
    });

    // Handle Edit/Delete in Analytics Modal
    refs.analyticsList.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const action = target.dataset.action;
      const id = target.dataset.id;
      if (!action || !id) return;

      if (state.role !== "admin") {
        showToast("Admin access required", "error");
        return;
      }

      const voter = state.voters.find(v => v.id === id);
      if (!voter) return;

      if (action === "edit") {
        openEditModal(voter);
      } else if (action === "delete") {
        const confirmed = confirm(`Delete voter ${voter.voterName}?`);
        if (!confirmed) return;
        remove(ref(db, `voters/${id}`))
          .then(() => {
            showToast("Voter deleted", "success");
            // Refresh modal if open
            if (analyticsFilterMeta) {
              const updatedVoters = analyticsFilterMeta.voters.filter(v => v.id !== id);
              analyticsFilterMeta.voters = updatedVoters;
              // Re-trigger render logic or simply remove row?
              // Simplest is to remove row from DOM
              target.closest("tr")?.remove();
            }
          })
          .catch(err => {
            console.error(err);
            showToast("Failed to delete voter", "error");
          });
      }
    });

    function closeAnalyticsModal() {
      refs.analyticsModal.classList.remove("visible");
      analyticsFilterMeta = null;
      refs.analyticsList.innerHTML = "<tr><td colspan='10'>No voters found.</td></tr>";
    }

    refs.analyticsModalClose.addEventListener("click", closeAnalyticsModal);
    refs.analyticsModalExport.addEventListener("click", () => {
      if (!analyticsFilterMeta?.voters?.length) {
        showToast("Nothing to export", "error");
        return;
      }
      const headers = ["List No.", "Name (EN)", "Name (MR)", "EPIC", "Booth", "District", "Taluka", "Caste", "Gender", "Mobile", "Address"];
      const rows = analyticsFilterMeta.voters.map(v => [
        (v.listNo || "").toString().toUpperCase(),
        (v.voterName || "").toUpperCase(),
        (v.voterNameMr || ""),
        (v.epicNo || "").toUpperCase(),
        (v.boothNo || "").toString().toUpperCase(),
        (v.district || "").toUpperCase(),
        (v.taluka || "").toUpperCase(),
        (v.caste || "").toUpperCase(),
        (v.gender || "").toUpperCase(),
        (v.mobileNo || "").toUpperCase(),
        (v.address || "").toUpperCase()
      ]);
      const csv = [headers, ...rows].map(row => row.map(value => {
        const safe = `${value}`.replace(/"/g, '""');
        return `"${safe}"`;
      }).join(",")).join("\r\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${analyticsFilterMeta.label || "analytics"}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);
      showToast("Exported analytics CSV", "success");
    });

    if (refs.analyticsModalPrint) {
      refs.analyticsModalPrint.addEventListener("click", () => {
        if (!analyticsFilterMeta?.voters?.length) {
          showToast("Nothing to print", "error");
          return;
        }
        printVotersList(analyticsFilterMeta.label || "Voter List", analyticsFilterMeta.voters);
      });
    }

    if (refs.printAnalyticsSummary) {
      refs.printAnalyticsSummary.addEventListener("click", () => {
        printAnalyticsReport();
      });
    }

    function printVotersList(title, voters) {
      const printWindow = window.open('', '_blank');
      const lang = state.lang;
      const headers = lang === 'mr'
        ? ["यादी क्र.", "नाव", "EPIC", "बुथ", "लिंग", "मोबाईल", "पत्ता"]
        : ["LIST NO", "NAME", "EPIC", "BOOTH", "GENDER", "MOBILE", "ADDRESS"];

      let rowsHtml = voters.map(v => `
        <tr>
          <td>${(v.listNo || "").toString().toUpperCase()}</td>
          <td>${(v.voterName || "").toUpperCase()}<br/><small style="color:#666">${v.voterNameMr || ""}</small></td>
          <td>${(v.epicNo || "").toUpperCase()}</td>
          <td>${(v.boothNo || "").toString().toUpperCase()}</td>
          <td>${lang === 'mr' ? (v.genderMr || v.gender || "") : (v.gender || "").toUpperCase()}</td>
          <td>${(v.mobileNo || "").toUpperCase()}</td>
          <td>${(v.address || "").toString().toUpperCase()}</td>
        </tr>
      `).join('');

      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${title}</title>
          <style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; color: #333; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
            th, td { border: 1px solid #999; padding: 8px; text-align: left; font-size: 11px; word-wrap: break-word; }
            th { background-color: #f2f2f2; font-weight: bold; text-transform: uppercase; }
            h1 { text-align: center; margin-bottom: 5px; font-size: 18px; }
            .header-info { text-align: center; margin-bottom: 20px; font-size: 12px; color: #555; }
            @media print {
              @page { margin: 1cm; }
              body { padding: 0; }
            }
          </style>
        </head>
        <body>
          <h1>RAYGAON VOTER MANAGEMENT</h1>
          <div class="header-info">REPORT: ${title.toUpperCase()} | TOTAL RECORDS: ${voters.length} | DATE: ${new Date().toLocaleDateString()}</div>
          <table>
            <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
            <tbody>${rowsHtml}</tbody>
          </table>
          <script>
            window.onload = function() { 
              setTimeout(() => {
                window.print(); 
                window.close();
              }, 500);
            }
          <\/script>
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    function printAnalyticsReport() {
      const tbody = document.getElementById("analyticsBody");
      const categoryLabel = document.getElementById("analyticsCategoryHeader").textContent;
      const title = dictionary[state.lang].analytics_title + " - " + categoryLabel;
      const printWindow = window.open('', '_blank');

      const headHtml = document.querySelector("#analyticsSection table thead").innerHTML;
      const bodyHtml = tbody.innerHTML;

      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${title}</title>
          <style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; color: #333; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #999; padding: 12px; text-align: left; }
            th { background-color: #f2f2f2; font-weight: bold; text-transform: uppercase; }
            h1 { text-align: center; margin-bottom: 5px; font-size: 22px; }
            .header-info { text-align: center; margin-bottom: 30px; font-size: 14px; color: #555; }
            .table-actions { display: none; }
            tr.grand-total-row { background-color: #f1f5f9 !important; font-weight: bold; }
            tr.grand-total-row td { color: #1e293b !important; border-top: 2px solid #333; }
            @media print {
              body { padding: 0; }
              .table-actions { display: none !important; }
            }
          </style>
        </head>
        <body>
          <h1>RAYGAON VOTER MANAGEMENT</h1>
          <div class="header-info">SUMMARY REPORT: ${categoryLabel.toUpperCase()} | DATE: ${new Date().toLocaleDateString()}</div>
          <table>
            <thead>${headHtml}</thead>
            <tbody>${bodyHtml}</tbody>
          </table>
          <script>
            window.onload = function() { 
              setTimeout(() => {
                window.print(); 
                window.close();
              }, 500);
            }
          <\/script>
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    window.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && refs.analyticsModal.classList.contains("visible")) {
        closeAnalyticsModal();
      }
    });

    function printVoterSlip(voter) {
      const printWindow = window.open('', '_blank', 'width=300,height=400');
      const content = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Voter Slip</title>
          <style>
            @media print {
              @page {
                size: 58mm auto;
                margin: 0;
              }
            }
            body {
              font-family: 'Courier New', monospace;
              width: 58mm;
              margin: 0;
              padding: 8px;
              font-size: 11px;
              line-height: 1.4;
            }
            .header {
              text-align: center;
              font-weight: bold;
              font-size: 13px;
              margin-bottom: 8px;
              border-bottom: 1px dashed #000;
              padding-bottom: 6px;
            }
            .field {
              margin: 6px 0;
              display: flex;
              flex-direction: column;
            }
            .label {
              font-weight: bold;
              font-size: 10px;
              color: #333;
            }
            .value {
              font-size: 12px;
              font-weight: bold;
              margin-top: 2px;
            }
            .footer {
              margin-top: 10px;
              padding-top: 6px;
              border-top: 1px dashed #000;
              text-align: center;
              font-size: 9px;
            }
          </style>
        </head>
        <body>
          <div class="header">RAYGAON VOTER SLIP</div>
          <div class="field">
            <span class="label">VOTER NAME:</span>
            <span class="value">${voter.voterName || 'N/A'}</span>
            <span class="value">${voter.voterNameMr || ''}</span>
          </div>
          <div class="field">
            <span class="label">${state.lang === 'mr' ? 'जात' : 'CASTE'}:</span>
            <span class="value">${state.lang === 'mr' ? (voter.casteMr || dictionary['mr'][voter.caste?.toUpperCase()] || voter.caste) : (voter.caste || 'N/A')}</span>
          </div>
          <div class="field">
            <span class="label">VOTER LIST SR NO:</span>
            <span class="value">${voter.listNo || 'N/A'}</span>
          </div>
          <div class="field">
            <span class="label">BOOTH:</span>
            <span class="value">${voter.boothNo || 'N/A'}</span>
          </div>
          <div class="footer">
            Printed: ${new Date().toLocaleString()}
          </div>
        </body>
        </html>
      `;

      printWindow.document.write(content);
      printWindow.document.close();

      printWindow.onload = function () {
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 250);
      };

      showToast("Print dialog opened", "success");
    }

    // Search Voter Functionality
    const searchVoterInput = document.getElementById("searchVoterInput");
    const searchResults = document.getElementById("searchResults");

    if (searchVoterInput) {
      searchVoterInput.addEventListener("input", (e) => {
        const query = e.target.value.trim().toLowerCase();

        if (!query) {
          searchResults.innerHTML = "";
          return;
        }

        const matches = state.voters.filter(v =>
          v.voterName?.toLowerCase().includes(query) ||
          v.epicNo?.toLowerCase().includes(query)
        );

        if (matches.length === 0) {
          searchResults.innerHTML = `
            <div class="no-results">
              <i class="fas fa-search-minus"></i>
              <p>No voters found matching "${e.target.value}"</p>
            </div>
          `;
          return;
        }

        searchResults.innerHTML = `
          <div class="results-count">
            Found ${matches.length} voter(s)
          </div>
          ${matches.map(v => `
            <div class="result-card">
              <div class="result-info">
                <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                  <h4 style="margin: 0;">${v.voterName || 'N/A'}</h4>
                  ${v.isFamilyHead ? `<span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold;">${state.lang === 'mr' ? 'प्रमुख' : 'Head'}</span>` : ''}
                </div>
                <div class="result-meta">
                  <div class="meta-item">
                    <i class="fas fa-id-card"></i> <strong>EPIC:</strong> ${v.epicNo || 'N/A'}
                  </div>
                  <div class="meta-item">
                    <i class="fas fa-list-ol"></i> <strong>List No:</strong> ${v.listNo || 'N/A'}
                  </div>
                  <div class="meta-item">
                    <i class="fas fa-map-marker-alt"></i> <strong>Booth:</strong> ${v.boothNo || 'N/A'}
                  </div>
                  <div class="meta-item">
                    <i class="fas fa-city"></i> <strong>District:</strong> ${v.district || 'N/A'}
                  </div>
                  <div class="meta-item">
                    <i class="fas fa-users"></i> <strong>${state.lang === 'mr' ? 'जात' : 'Caste'}:</strong> ${state.lang === 'mr' ? (v.casteMr || dictionary['mr'][v.caste?.toUpperCase()] || v.caste || 'N/A') : (v.caste || 'N/A')}
                  </div>
                </div>
              </div>
              <button class="primary search-print-btn" data-voter-id="${v.id}" style="white-space: nowrap;">
                <i class="fas fa-print"></i> Print Slip
              </button>
            </div>
          `).join('')}
        `;
      });

      // Handle print button clicks in search results
      searchResults.addEventListener("click", (e) => {
        const printBtn = e.target.closest(".search-print-btn");
        if (!printBtn) return;

        const voterId = printBtn.dataset.voterId;
        const voter = state.voters.find(v => v.id === voterId);
        if (voter) {
          printVoterSlip(voter);
        }
      });
    }

    function downloadSampleCSV(filename, rows) {
      const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/).filter(Boolean);
      if (!lines.length) return { headers: [], rows: [] };

      // Helper to split CSV line respecting quotes
      const splitLine = (line) => {
        const values = [];
        let current = '';
        let inQuote = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            inQuote = !inQuote;
          } else if (char === ',' && !inQuote) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim());
        return values.map(v => v.replace(/^"|"$/g, '').replace(/""/g, '"'));
      };

      const headers = splitLine(lines.shift());
      const rows = lines.map(line => {
        const values = splitLine(line);
        const entry = {};
        headers.forEach((header, idx) => entry[header] = values[idx] ?? "");
        return entry;
      });
      return { headers, rows };
    }

    async function handleCSVImport(file, type) {
      if (!file) return;
      const lang = state.lang;
      if (state.role !== "admin") {
        showToast(lang === 'mr' ? "ॲडमिन प्रवेश आवश्यक आहे" : "Admin access required", "error");
        return;
      }
      const reader = new FileReader();

      // Feedback to user that import has started
      showToast(lang === 'mr' ? "डेटा इंपोर्ट होत आहे... कृपया थांबा" : "Importing data... Please wait", "info");

      reader.onload = async ({ target }) => {
        try {
          const { headers, rows } = parseCSV(target.result || "");
          const expected = type === "voter" ? voterCSVHeaders : staffCSVHeaders;
          if (!expected.every(field => headers.includes(field))) {
            showToast(`Missing required headers: ${expected.join(", ")}`, "error");
            return;
          }
          if (!rows.length) {
            showToast("No records found in CSV", "error");
            return;
          }
          if (type === "voter") {
            await importVotersFromRows(rows);
          } else {
            await importStaffFromRows(rows);
          }
        } catch (err) {
          console.error(err);
          showToast("Failed to parse CSV", "error");
        }
      };
      reader.readAsText(file);
    }

    async function importVotersFromRows(rows) {
      const total = rows.length;
      const { container, bar, stats, percent, count } = refs.voterProgress;

      container.style.display = "block";
      stats.style.display = "flex";
      bar.style.width = "0%";
      percent.textContent = "0%";
      count.textContent = `0 / ${total}`;

      let done = 0;
      for (const row of rows) {
        const payload = {
          boothNo: row.boothNo || "",
          listNo: row.listNo || "",
          voterName: row.voterName || "",
          voterNameMr: row.voterNameMr || "",
          epicNo: (row.epicNo || "").toUpperCase(),
          mobileNo: row.mobileNo || "",
          district: row.district || "",
          taluka: row.taluka || "",
          gender: row.gender || "",
          voterType: row.voterType || "",
          caste: row.caste || "",
          village: row.village || "",
          address: row.address || "",
          isFamilyHead: row.isFamilyHead === "true" || row.isFamilyHead === "TRUE" || row.isFamilyHead === "1",
          createdAt: Date.now()
        };
        try {
          await push(ref(db, "voters"), payload);
          done++;
          const p = Math.round((done / total) * 100);
          bar.style.width = `${p}%`;
          percent.textContent = `${p}%`;
          count.textContent = `${done} / ${total}`;
        } catch (err) {
          console.error("Row import failed:", err);
        }
      }

      setTimeout(() => {
        showToast(state.lang === 'mr' ? `आयात पूर्ण झाली! ${done} मतदार जोडले.` : `Import Completed! Added ${done} voters.`, "success");
        setTimeout(() => {
          container.style.display = "none";
          stats.style.display = "none";
        }, 3000);
      }, 500);
    }

    async function importStaffFromRows(rows) {
      const total = rows.length;
      const { container, bar, stats, percent, count } = refs.staffProgress;

      container.style.display = "block";
      stats.style.display = "flex";
      bar.style.width = "0%";
      percent.textContent = "0%";
      count.textContent = `0 / ${total}`;

      let done = 0;
      for (const row of rows) {
        const payload = {
          village: "Raygaon",
          name: row.name || "",
          boothNo: row.boothNo || "",
          caste: row.caste || "",
          designation: row.designation || "",
          workplace: row.workplace || "",
          mobile: row.mobile || "",
          houseVoters: Number(row.houseVoters || 0),
          createdAt: Date.now()
        };
        try {
          await push(ref(db, "staff"), payload);
          done++;
          const p = Math.round((done / total) * 100);
          bar.style.width = `${p}%`;
          percent.textContent = `${p}%`;
          count.textContent = `${done} / ${total}`;
        } catch (err) {
          console.error("Row import failed:", err);
        }
      }

      setTimeout(() => {
        showToast(state.lang === 'mr' ? `आयात पूर्ण झाली! ${done} कर्मचारी जोडले.` : `Import Completed! Added ${done} staff records.`, "success");
        setTimeout(() => {
          container.style.display = "none";
          stats.style.display = "none";
        }, 3000);
      }, 500);
    }

    // Duplicate List Functions
    function getDuplicateGroups() {
      const groups = [];

      const normalize = (str) => (str || "").toLowerCase()
        .replace(/[.,]/g, '')
        .replace(/[^a-z0-9\u0900-\u097F\s]/g, '')
        .replace(/\s+/g, ' ')
        .trim();

      const enMap = {};
      const mrMap = {};

      state.voters.forEach(v => {
        const gender = (v.gender || "unknown").toLowerCase();

        const enName = normalize(v.voterName);
        if (enName.length > 2) {
          const k = enName + "|" + gender;
          if (!enMap[k]) enMap[k] = [];
          enMap[k].push(v);
        }

        const mrName = normalize(v.voterNameMr);
        if (mrName.length > 2) {
          const k = mrName + "|" + gender;
          if (!mrMap[k]) mrMap[k] = [];
          mrMap[k].push(v);
        }
      });

      Object.values(enMap).forEach(list => {
        if (list.length > 1) groups.push(list);
      });

      Object.values(mrMap).forEach(list => {
        if (list.length > 1) groups.push(list);
      });

      const uniqueGroupsMap = new Map();

      groups.forEach(group => {
        const sortedIds = group.map(v => v.id).sort().join(",");

        if (!uniqueGroupsMap.has(sortedIds)) {
          const uniqueVoters = Array.from(new Map(group.map(item => [item.id, item])).values());
          uniqueGroupsMap.set(sortedIds, uniqueVoters);
        }
      });

      return Array.from(uniqueGroupsMap.values());
    }

    function renderDuplicateListTable() {
      const tableBody = document.getElementById("duplicateListTableBody");
      const countSpan = document.getElementById("duplicateCount");
      if (!tableBody) return;

      const duplicates = getDuplicateGroups();
      if (countSpan) countSpan.textContent = duplicates.length;

      if (duplicates.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">${state.lang === 'mr' ? 'दुप्पट मतदार आढळले नाहीत.' : 'No duplicate voters found.'}</td></tr>`;
        return;
      }

      const lang = state.lang;
      const rows = duplicates.map((group, idx) => {
        const v1 = group[0];
        const detailsId = `dup-details-${idx}`;

        let detailsHtml = group.map(v => `
          <div style="background: rgba(0,0,0,0.2); padding: 0.75rem; margin: 0.5rem 0; border-radius: 0.5rem; border-left: 3px solid var(--danger);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
              <div><strong>${lang === 'mr' ? 'बुथ' : 'BOOTH'}:</strong> ${(v.boothNo || '-').toString().toUpperCase()}</div>
              <div><strong>${lang === 'mr' ? 'यादी क्र.' : 'LIST NO'}:</strong> ${(v.listNo || '-').toString().toUpperCase()}</div>
              <div><strong>EPIC:</strong> ${(v.epicNo || '-').toUpperCase()}</div>
              <div><strong>${lang === 'mr' ? 'मोबाईल' : 'MOBILE'}:</strong> ${(v.mobileNo || '-').toUpperCase()}</div>
            </div>
            <div style="margin-top: 0.5rem;"><strong>${lang === 'mr' ? 'पत्ता' : 'ADDRESS'}:</strong> ${lang === 'mr' ? (v.addressMr || v.address || '-') : (v.address || '').toUpperCase()}</div>
          </div>
        `).join('');

        return `
          <tr>
            <td>
              <div style="font-weight: 600;">${(v1.voterName || "").toUpperCase()}</div>
              <div style="color: var(--accent); font-size: 0.85rem; margin-top: 2px;">${v1.voterNameMr || ""}</div>
            </td>
            <td>${lang === 'mr' ? (v1.genderMr || v1.gender || '') : (v1.gender || '').toUpperCase()}</td>
            <td>
              <span style="background: var(--danger); color: white; padding: 0.25rem 0.75rem; border-radius: 99px; font-weight: 700;">
                ${group.length} ${lang === 'mr' ? 'नोंदी' : 'RECORDS'}
              </span>
            </td>
            <td>
              <button class="action-btn view" onclick="document.getElementById('${detailsId}').style.display = document.getElementById('${detailsId}').style.display === 'none' ? 'table-row' : 'none';">
                <i class="fas fa-eye"></i> ${dictionary[lang].view_details || 'View Details'}
              </button>
            </td>
          </tr>
          <tr id="${detailsId}" style="display: none;">
            <td colspan="4" style="background: rgba(239, 68, 68, 0.05); padding: 1rem;">
              <h4 style="margin-top: 0; color: var(--danger);">${lang === 'mr' ? 'दुप्पट नोंदींचा तपशील' : 'Duplicate Records Details'}</h4>
              ${detailsHtml}
            </td>
          </tr>
        `;
      }).join("");

      tableBody.innerHTML = rows;
    }

    function subscribeToData() {
      onValue(ref(db, "voters"), (snapshot) => {
        const data = snapshot.val() || {};
        state.voters = Object.entries(data).map(([id, value]) => ({ id, ...value }));

        // Auto-fix Sangli spelling if any exist
        if (state.voters.length > 0) {
          const hasSangali = state.voters.some(v => v.district && v.district.trim().toUpperCase() === "SANGALI");
          if (hasSangali) {
            fixSangli();
          }
        }

        updateOverview();
        renderVoterTable();
        renderAnalytics();
        renderFamilyHeadTable();
        renderDuplicateListTable();
        renderVotedTable();
      });
      onValue(ref(db, "staff"), (snapshot) => {
        const data = snapshot.val() || {};
        state.staff = Object.entries(data).map(([id, value]) => ({ id, ...value }));
        updateOverview();
      });
      onValue(ref(db, "users"), (snapshot) => {
        const data = snapshot.val() || {};
        state.users = Object.entries(data).map(([id, value]) => ({ id, ...value }));
        renderUserLogins();
      });
      onValue(ref(db, "admins"), (snapshot) => {
        const data = snapshot.val() || {};
        state.admins = Object.entries(data).map(([id, value]) => ({ id, ...value }));
        renderAdmins();
      });
    }

    function updateOverview() {
      const total = state.voters.length;
      const female = state.voters.filter(v => (v.gender || "").toString().trim().toLowerCase() === "female").length;
      const male = state.voters.filter(v => (v.gender || "").toString().trim().toLowerCase() === "male").length;
      document.getElementById("totalVoters").textContent = total;
      document.getElementById("femaleVoters").textContent = female;
      document.getElementById("maleVoters").textContent = male;
      document.getElementById("staffCount").textContent = state.staff.length;

      const totalVoted = state.voters.filter(v => v.isVoted).length;
      if (refs.votedSummaryCount) refs.votedSummaryCount.textContent = totalVoted;
      if (refs.votedCount) refs.votedCount.textContent = totalVoted;

      if (refs.totalVotingPercent) {
        const percent = total > 0 ? Math.round((totalVoted / total) * 100) : 0;
        refs.totalVotingPercent.textContent = `${percent}%`;
      }

      // Booth-wise Summary
      const boothMap = {};
      state.voters.forEach(v => {
        const b = (v.boothNo || "Unspecified").toString().trim();
        if (!boothMap[b]) boothMap[b] = { total: 0, male: 0, female: 0, voted: 0, votedMale: 0, votedFemale: 0 };
        boothMap[b].total++;
        const g = (v.gender || "").toString().trim().toLowerCase();
        if (g === "male") {
          boothMap[b].male++;
          if (v.isVoted) boothMap[b].votedMale++;
        } else if (g === "female") {
          boothMap[b].female++;
          if (v.isVoted) boothMap[b].votedFemale++;
        }

        if (v.isVoted) boothMap[b].voted++;
      });

      const boothGrid = document.getElementById("boothStatsGrid");
      if (boothGrid) {
        if (Object.keys(boothMap).length === 0) {
          boothGrid.innerHTML = "";
        } else {
          const lang = state.lang;
          boothGrid.innerHTML = Object.entries(boothMap)
            .sort((a, b) => a[0].localeCompare(b[0], undefined, { numeric: true }))
            .map(([booth, stats]) => {
              const label = lang === "mr" ? `बुथ ${booth} मतदार` : `Booth ${booth} Voters`;
              const maleLabel = lang === "mr" ? "पुरुष" : "Male";
              const femaleLabel = lang === "mr" ? "महिला" : "Female";
              const votedLabel = lang === 'mr' ? 'झालेले मतदान' : 'Voted';
              const pendingLabel = lang === 'mr' ? 'बाकी' : 'Pending';

              const totalPercent = stats.total > 0 ? Math.round((stats.voted / stats.total) * 100) : 0;

              return `
              <div class="booth-card">
                <div class="booth-card-header">
                  <span class="booth-label">${label}</span>
                  <span class="booth-percent-pill">${totalPercent}%</span>
                </div>
                
                <div class="booth-progress-container" style="margin: 1rem 0;">
                  <div class="booth-progress-bar" style="width: ${totalPercent}%"></div>
                </div>

                <div class="booth-main-stats">
                  <span class="voted-big-value">${stats.voted}</span>
                  <span class="total-subtitle">${votedLabel} / ${stats.total} TOTAL</span>
                </div>

                <div style="text-align: center; margin-top: -0.5rem; font-size: 0.85rem; color: var(--danger); font-weight: 800;">
                   <i class="fas fa-exclamation-circle" style="margin-right: 4px;"></i> ${dictionary[lang].pending_votes}: ${stats.total - stats.voted}
                </div>

                <div class="booth-footer-grid">
                  <div class="gender-box">
                    <span class="gender-value">${stats.votedMale} / ${stats.male}</span>
                    <span class="gender-label">${maleLabel}</span>
                    <span class="pending-small">${pendingLabel}: ${stats.male - stats.votedMale}</span>
                  </div>
                  
                  <div class="gender-box">
                    <span class="gender-value">${stats.votedFemale} / ${stats.female}</span>
                    <span class="gender-label">${femaleLabel}</span>
                    <span class="pending-small">${pendingLabel}: ${stats.female - stats.votedFemale}</span>
                  </div>
                </div>
              </div>`;
            }).join("");
        }
      }

      populateStaffFilters();
      populateVoterFilters();
      renderStaffDirectory();
    }

    function populateStaffFilters() {
      const booths = Array.from(new Set(state.staff.map(s => s.boothNo).filter(Boolean))).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
      refs.staffFilterBooth.innerHTML = `<option value="">${state.lang === 'mr' ? 'सर्व बुथ' : 'All Booths'}</option>` + booths.map(booth => `<option value="${booth}">${booth}</option>`).join("");
      // Caste filter is populated once during initialization with fixed options
    }

    function populateVoterFilters() {
      const booths = Array.from(new Set(state.voters.map(v => v.boothNo).filter(Boolean))).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
      const currentBooth = refs.filterBooth?.value || "";
      if (refs.filterBooth) {
        refs.filterBooth.innerHTML = `<option value="">${state.lang === 'mr' ? 'सर्व बुथ' : 'All Booths'}</option>` + booths.map(booth => `<option value="${booth}">${booth}</option>`).join("");
        if (currentBooth && booths.includes(currentBooth)) {
          refs.filterBooth.value = currentBooth;
        }
      }
    }

    function getFilteredStaff() {
      const boothFilter = refs.staffFilterBooth.value;
      const casteFilter = refs.staffFilterCaste.value;
      const query = (refs.staffSearchText.value || "").trim().toLowerCase();

      return state.staff.filter(staff => {
        if (boothFilter && staff.boothNo !== boothFilter) return false;
        if (casteFilter && staff.caste !== casteFilter) return false;
        if (query && !(
          (staff.name || "").toLowerCase().includes(query) ||
          (staff.nameMr || "").toLowerCase().includes(query) ||
          (staff.caste || "").toLowerCase().includes(query) ||
          (staff.casteMr || "").toLowerCase().includes(query) ||
          (staff.designation || "").toLowerCase().includes(query) ||
          (staff.designationMr || "").toLowerCase().includes(query)
        )) return false;
        return true;
      });
    }

    function renderStaffDirectory() {
      const lang = state.lang;
      if (!state.staff.length) {
        refs.staffDirectoryBody.innerHTML = "<tr><td colspan='8'>No staff records found.</td></tr>";
        return;
      }
      const rows = getFilteredStaff()
        .map(staff => {
          const actions = state.role === "admin"
            ? `<div class="table-actions">
                <button class="action-btn edit" data-staff-action="edit" data-id="${staff.id}">
                  <i class="fas fa-edit"></i> ${dictionary[lang].edit}
                </button>
                <button class="action-btn delete" data-staff-action="delete" data-id="${staff.id}">
                  <i class="fas fa-trash-alt"></i> ${dictionary[lang].delete}
                </button>
              </div>`
            : "<span style='color:var(--muted);'>Read-only</span>";
          return `
          <tr>
            <td>
              <div style="font-weight: 600;">${staff.name || ""}</div>
              <div style="color: var(--accent); font-size: 0.85rem; margin-top: 2px;">${staff.nameMr || ""}</div>
            </td>
            <td>${staff.boothNo || ""}</td>
            <td>
              ${lang === 'mr' ?
              `<div>${staff.casteMr || dictionary['mr'][staff.caste?.toUpperCase()] || staff.caste || ""}</div>` :
              `<div>${(staff.caste || "").toUpperCase()}</div>`
            }
            </td>
            <td>
              <div>${staff.designation || ""}</div>
              <div style="color: var(--accent); font-size: 0.8rem;">${staff.designationMr || ""}</div>
            </td>
            <td>
              <div>${staff.workplace || ""}</div>
              <div style="color: var(--accent); font-size: 0.8rem;">${staff.workplaceMr || ""}</div>
            </td>
            <td>${staff.mobile || ""}</td>
            <td>
              <button class="link-btn" title="Click to assign voters" 
                      data-staff-action="assign-voters" 
                      data-id="${staff.id}"
                      style="color: var(--accent); background: rgba(245, 158, 11, 0.1); border: 1px solid var(--accent); padding: 0.2rem 0.6rem; border-radius: 4px; cursor: pointer; font-weight: bold;">
                ${(staff.assignedVoters || []).length}
              </button>
            </td>
            <td>${actions}</td>
          </tr>`;
        }).join("");
      refs.staffDirectoryBody.innerHTML = rows || "<tr><td colspan='8'>No staff records match current filters.</td></tr>";
    }

    function renderUserLogins() {
      if (!refs.userLoginsBody) return;
      if (state.role !== "admin") return;

      if (!state.users.length) {
        refs.userLoginsBody.innerHTML = "<tr><td colspan='4'>No user logins tracked yet.</td></tr>";
        return;
      }

      const rows = state.users
        .sort((a, b) => (b.lastLogin || 0) - (a.lastLogin || 0))
        .map(u => `
          <tr>
            <td>${u.displayName}</td>
            <td>${u.email}</td>
            <td>${new Date(u.lastLogin).toLocaleString()}</td>
            <td><span class="status-badge" style="background:rgba(16,185,129,0.1); color:var(--success); border-color:var(--success);">${u.status}</span></td>
          </tr>
        `).join("");
      refs.userLoginsBody.innerHTML = rows;
    }

    function renderAdmins() {
      if (!refs.adminListBody || state.role !== "admin") return;

      if (!state.admins.length) {
        refs.adminListBody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding: 2rem; color: var(--text-muted);'>No additional admin accounts found.</td></tr>";
        return;
      }

      const rows = state.admins.map(a => `
        <tr>
          <td>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white;">
                ${(a.name || 'A')[0].toUpperCase()}
              </div>
              ${a.name}
            </div>
          </td>
          <td>${a.email}</td>
          <td>${new Date(a.createdAt).toLocaleString()}</td>
          <td>
            <button class="action-btn delete" data-id="${a.id}">
              <i class="fas fa-trash-alt"></i> Remove
            </button>
          </td>
        </tr>
      `).join("");
      refs.adminListBody.innerHTML = rows;
    }

    function openStaffModal(staff) {
      editingStaffId = staff.id;
      const f = refs.staffEditFields;
      f.name.value = staff.name || "";
      f.nameMr.value = staff.nameMr || "";
      f.boothNo.value = staff.boothNo || "";
      if (staff.caste) {
        const casteMatch = casteOptions.find(c => c.toUpperCase() === staff.caste.toUpperCase());
        f.caste.value = casteMatch || "";
      } else {
        f.caste.value = "";
      }
      f.casteMr.value = staff.casteMr || "";
      f.designation.value = staff.designation || "";
      f.designationMr.value = staff.designationMr || "";
      f.workplace.value = staff.workplace || "";
      f.workplaceMr.value = staff.workplaceMr || "";
      f.mobile.value = staff.mobile || "";
      f.houseVoters.value = staff.houseVoters ?? "";
      refs.staffModal.classList.add("visible");
    }

    function closeStaffModal() {
      refs.staffModal.classList.remove("visible");
      refs.staffEditForm.reset();
      editingStaffId = null;
    }

    refs.staffModalClose.addEventListener("click", closeStaffModal);
    refs.staffModalCancel.addEventListener("click", closeStaffModal);
    window.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && refs.staffModal.classList.contains("visible")) {
        closeStaffModal();
      }
    });

    refs.staffEditForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!editingStaffId) return;
      if (state.role !== "admin") {
        showToast("Admin access required", "error");
        return;
      }
      const payload = {
        name: refs.staffEditFields.name.value.trim(),
        nameMr: refs.staffEditFields.nameMr.value.trim(),
        boothNo: refs.staffEditFields.boothNo.value.trim(),
        caste: refs.staffEditFields.caste.value.trim(),
        casteMr: refs.staffEditFields.casteMr.value.trim(),
        designation: refs.staffEditFields.designation.value.trim(),
        designationMr: refs.staffEditFields.designationMr.value.trim(),
        workplace: refs.staffEditFields.workplace.value.trim(),
        workplaceMr: refs.staffEditFields.workplaceMr.value.trim(),
        mobile: refs.staffEditFields.mobile.value.trim(),
        houseVoters: Number(refs.staffEditFields.houseVoters.value || 0)
      };
      try {
        await update(ref(db, `staff/${editingStaffId}`), payload);
        showToast("Staff updated", "success");
        closeStaffModal();
      } catch (error) {
        console.error(error);
        showToast("Failed to update staff", "error");
      }
    });

    // Staff Directory Table Click Handler
    refs.staffDirectoryBody.addEventListener("click", (event) => {
      const button = event.target.closest("button[data-staff-action]");
      if (!button) return;

      const { staffAction, id } = button.dataset;
      const staff = state.staff.find(s => s.id === id);
      if (!staff) return;

      if (staffAction === "edit") {
        if (state.role !== "admin") {
          showToast("Admin access required", "error");
          return;
        }
        openStaffModal(staff);
      } else if (staffAction === "delete") {
        if (state.role !== "admin") {
          showToast("Admin access required", "error");
          return;
        }
        const confirmed = confirm(`Delete staff member ${staff.name}?`);
        if (!confirmed) return;
        remove(ref(db, `staff/${id}`))
          .then(() => showToast("Staff deleted", "success"))
          .catch(err => {
            console.error(err);
            showToast("Failed to delete staff", "error");
          });
      } else if (staffAction === "assign-voters") {
        // Allow both admin and user to open (user gets view-only mode)
        openAssignVotersModal(staff);
      }
    });

    function exportStaffDirectory() {
      const filtered = getFilteredStaff();
      if (!filtered.length) {
        showToast("No staff records to export", "error");
        return;
      }

      const boothFilter = refs.staffFilterBooth.value || "All Booths";
      const casteFilter = refs.staffFilterCaste.value || "All Castes";

      // Added a descriptive title row at the top as requested
      const titleRow = [`Raygaon Staff Directory (Filter: Booth-${boothFilter}, Caste-${casteFilter})`];
      const headers = ["Name (EN)", "Name (MR)", "Booth", "Caste (EN)", "Caste (MR)", "Designation (EN)", "Designation (MR)", "Workplace (EN)", "Workplace (MR)", "Mobile", "House Voters"];
      const rows = filtered.map(staff => [
        staff.name || "",
        staff.nameMr || "",
        staff.boothNo || "",
        staff.caste || "",
        staff.casteMr || "",
        staff.designation || "",
        staff.designationMr || "",
        staff.workplace || "",
        staff.workplaceMr || "",
        staff.mobile || "",
        staff.houseVoters ?? "0"
      ]);

      const csvContent = [
        titleRow.join(","),
        headers.join(","),
        ...rows.map(row => row.map(value => `"${`${value}`.replace(/"/g, '""')}"`).join(","))
      ].join("\r\n");

      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `Raygaon_Staff_${boothFilter}_${casteFilter}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);
      showToast("Staff directory exported successfully", "success");
    }

    function exportVoterDirectory() {
      const filtered = state.voters.filter(passesFilters);
      if (!filtered.length) {
        showToast("No voter records to export", "error");
        return;
      }

      const title = `Raygaon Voter Directory Exported: ${new Date().toLocaleDateString()}`;
      const headers = ["List No", "Name (EN)", "Name (MR)", "EPIC No", "Booth", "District (EN)", "District (MR)", "Taluka (EN)", "Taluka (MR)", "Caste (EN)", "Caste (MR)", "Gender (EN)", "Gender (MR)", "Mobile", "Address (EN)", "Address (MR)", "Type", "Family Head", "Status"];
      const rows = filtered
        .sort((a, b) => Number(a.listNo || 0) - Number(b.listNo || 0))
        .map(v => {
          // removed name modification

          return [
            (v.listNo || "").toString().toUpperCase(),
            (v.voterName || "").toUpperCase(),
            v.voterNameMr || "",
            (v.epicNo || "").toUpperCase(),
            (v.boothNo || "").toString().toUpperCase(),
            (v.district || "").toUpperCase(),
            v.districtMr || (v.district || "").toUpperCase(), // Fallback if not converted
            (v.taluka || "").toUpperCase(),
            v.talukaMr || (v.taluka || "").toUpperCase(),
            (v.caste || "").toUpperCase(),
            v.casteMr || (v.caste || "").toUpperCase(),
            (v.gender || "").toUpperCase(),
            v.genderMr || (state.lang === 'mr' && v.gender === 'Male' ? 'पुरुष' : (v.gender === 'Female' ? 'महिला' : v.gender)),
            (v.mobileNo || "").toUpperCase(),
            (v.address || "").toUpperCase(),
            v.addressMr || (v.address || "").toUpperCase(),
            (v.voterType || "").toUpperCase(),
            v.isFamilyHead ? "YES" : "NO",
            v.isDeceased ? "DEATH" : ""
          ];
        });

      const csvContent = [
        title,
        headers.join(","),
        ...rows.map(row => row.map(value => `"${`${value}`.replace(/"/g, '""')}"`).join(","))
      ].join("\r\n");

      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `Raygaon_Voters_${new Date().toISOString().split("T")[0]}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);
      showToast("Voter directory exported successfully", "success");
    }

    function passesFilters(voter) {
      const { value: district } = refs.filterDistrict;
      const { value: taluka } = refs.filterTaluka;
      const { value: booth } = refs.filterBooth;
      const { value: caste } = refs.filterCaste;
      const { value: gender } = refs.filterGender;
      const { value: type } = refs.filterVoterType;
      const query = refs.searchText.value.trim().toLowerCase();

      const vDistrict = (voter.district || "").toLowerCase();
      const vTaluka = (voter.taluka || "").toLowerCase();
      const vBooth = (voter.boothNo || "").toLowerCase();
      const vCaste = (voter.caste || "").toLowerCase();
      const vGender = (voter.gender || "").toLowerCase();

      if (district && vDistrict !== district.toLowerCase()) return false;
      if (taluka && vTaluka !== taluka.toLowerCase()) return false;
      if (booth && vBooth !== booth.toLowerCase()) return false;
      if (caste && vCaste !== caste.toLowerCase()) return false;
      if (gender && vGender !== gender.toLowerCase()) return false;
      if (type && voter.voterType !== type) return false;
      if (query && !(`${voter.voterName}`.toLowerCase().includes(query) || `${voter.voterNameMr}`.toLowerCase().includes(query) || `${voter.epicNo}`.toLowerCase().includes(query))) return false;
      return true;
    }

    function renderVoterTable() {
      console.log("Rendering voter table. User role:", state.role);
      const lang = state.lang;
      if (!state.voters.length) {
        const colspan = state.role === 'admin' ? 12 : 11;
        refs.voterTableBody.innerHTML = `<tr><td colspan='${colspan}'>${lang === 'mr' ? 'अद्याप मतदारांची नोंद नाही.' : 'No voter records yet.'}</td></tr>`;
        return;
      }

      // Show all voters that pass filters (including deceased)
      const filtered = state.voters.filter(passesFilters);

      if (!filtered.length) {
        const colspan = state.role === 'admin' ? 12 : 11;
        refs.voterTableBody.innerHTML = `<tr><td colspan='${colspan}'>${lang === 'mr' ? 'फिल्टरनुसार माहिती सापडली नाही.' : 'No data matches the current filters.'}</td></tr>`;
        return;
      }
      const rows = filtered
        .sort((a, b) => Number(a.listNo || 0) - Number(b.listNo || 0))
        .map(v => {
          const isDeceased = !!v.isDeceased;
          const isVoted = !!v.isVoted;

          const markVotedBtn = isVoted
            ? `<button class="action-btn success" data-action="unmark-voted" data-id="${v.id}" title="${dictionary[lang].unmark_voted_btn}"><i class="fas fa-check-double"></i></button>`
            : `<button class="action-btn" data-action="mark-voted" data-id="${v.id}" title="${dictionary[lang].mark_voted_btn}"><i class="fas fa-check"></i></button>`;

          const actions = state.role === "admin"
            ? `<div class="table-actions">
                ${!isDeceased ? markVotedBtn : ''}
                <button class="action-btn edit" data-action="edit" data-id="${v.id}">${dictionary[lang].edit}</button>
                ${!isDeceased ? `<button class="action-btn danger" data-action="mark-deceased" data-id="${v.id}" title="${dictionary[lang].mark_deceased_btn}"><i class="fas fa-user-times"></i></button>` : ''}
                <button class="action-btn delete" data-action="delete" data-id="${v.id}">${dictionary[lang].delete}</button>
              </div>`
            : `<div class="table-actions">
                ${!isDeceased ? markVotedBtn : ''}
              </div>`;

          let rowStyle = '';
          if (isDeceased) rowStyle = 'style="background: rgba(239, 68, 68, 0.05);"';
          else if (isVoted) rowStyle = 'style="background: rgba(16, 185, 129, 0.05);"';

          const nameStyle = isDeceased ? 'color: var(--danger);' : (isVoted ? 'color: var(--success);' : '');

          return `
          <tr ${rowStyle}>
            <td>${(v.listNo || "").toString().toUpperCase()}</td>
            <td>
              <div style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; ${nameStyle}">
                ${(v.voterName || "").toUpperCase()}
                ${v.isFamilyHead ? `<span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 1px 4px; border-radius: 4px; text-transform: uppercase;">${lang === 'mr' ? 'प्रमुख' : 'HEAD'}</span>` : ''}
                ${isDeceased ? `<span style="background: var(--danger); color: white; font-size: 0.65rem; padding: 1px 6px; border-radius: 4px; text-transform: uppercase; font-weight: 800;">${(dictionary[lang].status_deceased || "").toUpperCase()}</span>` : ''}
                ${isVoted ? `<span style="background: var(--success); color: white; font-size: 0.65rem; padding: 1px 6px; border-radius: 4px; text-transform: uppercase; font-weight: 800;">${(dictionary[lang].voted_status || "").toUpperCase()}</span>` : ''}
              </div>
              <div style="color: var(--accent); font-size: 0.85rem; margin-top: 2px; ${isDeceased || isVoted ? 'opacity: 0.7;' : ''}">${v.voterNameMr || ""}</div>
            </td>
            <td>${(v.epicNo || "").toUpperCase()}</td>
            <td>${(v.boothNo || "").toString().toUpperCase()}</td>
            <td>${lang === 'mr' ? (v.districtMr || v.district) : (v.district || "").toUpperCase()}</td>
            <td>${lang === 'mr' ? (v.talukaMr || v.taluka) : (v.taluka || "").toUpperCase()}</td>
            <td>
              <div>${(v.caste || "").toUpperCase()}</div>
              <div style="color: var(--accent); font-size: 0.85rem; margin-top: 2px;">${dictionary['mr'][v.caste?.toUpperCase()] || v.casteMr || ""}</div>
            </td>
            <td>${lang === 'mr' ? (v.genderMr || (v.gender === 'Male' ? 'पुरुष' : (v.gender === 'Female' ? 'महिला' : v.gender))) : (v.gender || "").toUpperCase()}</td>
            <td>${(v.mobileNo || "").toUpperCase()}</td>
            <td>${lang === 'mr' ? (v.addressMr || v.address || "") : (v.address || "").toUpperCase()}</td>
            <td ${state.role === 'admin' ? '' : 'style="display:none;"'}>${(v.voterType || "-").toUpperCase()}</td>
            <td>${actions}</td>
          </tr>`;
        }).join("");
      refs.voterTableBody.innerHTML = rows;

      // Update Table Headers based on language
      const headers = refs.voterTableBody.closest("table").querySelectorAll("thead th");
      const labels = lang === "mr"
        ? ["यादी क्र.", "नाव", "EPIC", "बुथ", "जिल्हा", "तालुका", "जात", "लिंग", "मोबाईल", "पत्ता", "प्रकार", "क्रिया"]
        : ["LIST NO.", "NAME", "EPIC", "BOOTH", "DISTRICT", "TALUKA", "CASTE", "GENDER", "MOBILE", "ADDRESS", "TYPE", "ACTIONS"];
      headers.forEach((th, i) => { if (labels[i]) th.textContent = labels[i]; });
      console.log("Voter table rendered with", filtered.length, "rows");
    }

    async function markAsVoted(id) {
      try {
        await update(ref(db, `voters/${id}`), { isVoted: true });
        showToast(state.lang === 'mr' ? "मतदान झाले असे चिन्हांकित केले" : "Marked as voted", "success");
      } catch (error) {
        console.error(error);
        showToast("Error updating status", "error");
      }
    }

    async function unmarkAsVoted(id) {
      try {
        await update(ref(db, `voters/${id}`), { isVoted: null });
        showToast(state.lang === 'mr' ? "मतदान रद्द केले" : "Unmarked as voted", "info");
      } catch (error) {
        console.error(error);
        showToast("Error updating status", "error");
      }
    }

    function renderVotedTable() {
      const tableBody = refs.votedTableBody;
      const countSpan = refs.votedCount;
      if (!tableBody) return;
      tableBody.innerHTML = "";

      const votedVoters = state.voters.filter(v => v.isVoted);
      if (countSpan) countSpan.textContent = votedVoters.length;

      if (votedVoters.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No voted voters found.</td></tr>`;
        return;
      }

      const lang = state.lang;
      const label = dictionary[lang].unmark_voted_btn || "Unmark";

      const rows = votedVoters.map(v => `
           <tr>
               <td>${v.boothNo}</td>
               <td>${v.listNo}</td>
               <td>
                   <div style="font-weight:600; color:var(--success);">${v.voterName}</div>
                   <div style="color:var(--text-muted);font-size:0.85em;">${v.voterNameMr || ""}</div>
               </td>
               <td>${v.gender}</td>
               <td>${v.epicNo}</td>
               <td>
                   <button class="action-btn unmark-btn" data-id="${v.id}" style="background-color:var(--accent); color:white;">
                       <i class="fas fa-undo"></i> ${label}
                   </button>
               </td>
           </tr>
       `).join("");

      tableBody.innerHTML = rows;

      // Add Event Listeners
      tableBody.querySelectorAll(".unmark-btn").forEach(btn => {
        btn.addEventListener("click", () => unmarkAsVoted(btn.dataset.id));
      });
    }

    function exportVotedList() {
      const voted = state.voters.filter(v => v.isVoted);
      if (!voted.length) {
        showToast(state.lang === 'mr' ? "माहिती उपलब्ध नाही" : "No data to export", "error");
        return;
      }

      const headers = ["List No", "Name (EN)", "Name (MR)", "EPIC No", "Booth", "Gender", "Mobile"];
      const csvContent = [
        headers.join(","),
        ...voted.map(v => [
          `"${v.listNo || ""}"`,
          `"${v.voterName || ""}"`,
          `"${v.voterNameMr || ""}"`,
          `"${v.epicNo || ""}"`,
          `"${v.boothNo || ""}"`,
          `"${v.gender || ""}"`,
          `"${v.mobileNo || ""}"`
        ].join(","))
      ].join("\n");

      const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `Voted_Voters_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function renderAggregates() {
      const aggregates = {
        districtAggregate: groupCount(state.voters, "district"),
        talukaAggregate: groupCount(state.voters, "taluka"),
        casteAggregate: groupCount(state.voters, "caste"),
        genderAggregate: groupCount(state.voters, "gender")
      };
      Object.entries(aggregates).forEach(([key, list]) => {
        const target = document.getElementById(key);
        if (!list.length) {
          target.innerHTML = "<li>No data yet.</li>";
          return;
        }
        target.innerHTML = list.map(([label, count]) => `
          <li>
            <span>${label}</span>
            <button type="button" class="bucket-count" data-agg="${key}" data-label="${label}">${count}</button>
          </li>`).join("");
      });
    }

    function groupCount(items, key) {
      const map = new Map();
      items.forEach(item => {
        let val = item[key] || "Other";
        let value = val.toString().trim();
        if (value !== "Other") value = value.toUpperCase();
        map.set(value, (map.get(value) || 0) + 1);
      });
      return Array.from(map.entries()).sort((a, b) => b[1] - a[1]);
    }

    function renderDeceasedTable() {
      const tableBody = document.getElementById("deceasedTableBody");
      const countSpan = document.getElementById("deceasedCount");
      if (!tableBody) return;
      tableBody.innerHTML = "";

      const deceasedVoters = state.voters.filter(v => v.isDeceased);
      if (countSpan) countSpan.textContent = deceasedVoters.length;

      if (deceasedVoters.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No deceased voters found.</td></tr>`;
        return;
      }

      const lang = state.lang;
      const label = dictionary[lang].restore_btn || "Restore";

      const rows = deceasedVoters.map(v => `
           <tr>
               <td>${v.boothNo}</td>
               <td>${v.listNo}</td>
               <td>
                   <div>${v.voterName}</div>
                   <div style="color:var(--text-muted);font-size:0.85em;">${v.voterNameMr || ""}</div>
               </td>
               <td>${v.gender}</td>
               <td>${v.epicNo}</td>
               <td>
                   <button class="action-btn restore-btn" data-id="${v.id}" style="background-color:var(--success); color:white;">
                       <i class="fas fa-trash-restore"></i> ${label}
                   </button>
               </td>
           </tr>
       `).join("");

      tableBody.innerHTML = rows;

      // Add Event Listeners
      document.querySelectorAll(".restore-btn").forEach(btn => {
        btn.addEventListener("click", () => restoreDeceased(btn.dataset.id));
      });
    }

    async function markAsDeceased(id) {
      if (!confirm("Are you sure you want to mark this voter as Deceased? They will be moved to the Deceased List.")) return;
      try {
        await update(ref(db, `voters/${id}`), { isDeceased: true });
        showToast("Voter marked as deceased", "success");
        renderVoterTable(); // Force update if not reactive
      } catch (error) {
        console.error(error);
        showToast("Error updating status", "error");
      }
    }

    async function restoreDeceased(id) {
      if (!confirm("Restore this voter to the main list?")) return;
      try {
        await update(ref(db, `voters/${id}`), { isDeceased: null });
        showToast("Voter restored to list", "success");
        renderDeceasedTable();
      } catch (error) {
        console.error(error);
        showToast("Error restoring voter", "error");
      }
    }

    document.getElementById("showLoginBtn").addEventListener("click", () => {
      document.body.classList.add("login-active");
      document.body.classList.remove("dashboard-active");
      document.getElementById("landingSection").style.display = "none";
      document.getElementById("authSection").style.display = "grid";
    });

    document.getElementById("closeAuthBtn").addEventListener("click", () => {
      document.getElementById("authSection").style.display = "none";
      document.getElementById("landingSection").style.display = "flex";
    });

    const roleButtons = document.querySelectorAll(".auth-card .role-button");
    const adminLoginBlock = document.getElementById("adminLoginBlock");
    const userLoginBlock = document.getElementById("userLoginBlock");

    roleButtons.forEach(button => {
      button.addEventListener("click", () => {
        roleButtons.forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        const role = button.dataset.roleTab;
        const isAdmin = role === "admin";
        adminLoginBlock.classList.toggle("active", isAdmin);
        userLoginBlock.classList.toggle("active", !isAdmin);
      });
    });

    if (localStorage.getItem(ADMIN_SESSION_KEY) === "true") {
      setRole("admin", { displayName: ADMIN_CREDENTIALS.displayName, email: ADMIN_CREDENTIALS.email });
    }

    // Family Management Events
    if (refs.linkMembersSearch) {
      refs.linkMembersSearch.oninput = renderLinkMembersList;
      refs.linkMembersClose.onclick = () => refs.linkMembersModal.classList.remove("visible");
      refs.linkMembersCancel.onclick = () => refs.linkMembersModal.classList.remove("visible");
      refs.linkMembersSave.onclick = async () => {
        if (!linkingFamilyHeadId) return;
        const membersObj = {};
        selectedFamilyMemberIds.forEach(id => membersObj[id] = true);

        try {
          await update(ref(db, `voters/${linkingFamilyHeadId}`), {
            familyMembers: membersObj
          });
          showToast("Family members linked successfully", "success");
          refs.linkMembersModal.classList.remove("visible");
        } catch (err) {
          console.error(err);
          showToast("Error updating family", "error");
        }
      };
    }

    if (refs.exportFamilyData) {
      refs.exportFamilyData.onclick = exportFamilyData;
    }

    subscribeToData();

    // Mobile Menu Toggle Logic
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        if (sidebar && sidebarOverlay) {
          sidebar.classList.toggle("open");
          sidebarOverlay.classList.toggle("visible");
        }
      });

      if (sidebarOverlay) {
        sidebarOverlay.addEventListener("click", () => {
          sidebar.classList.remove("open");
          sidebarOverlay.classList.remove("visible");
        });
      }

      // Close sidebar when clicking outside
      document.addEventListener("click", (e) => {
        if (sidebar && sidebar.classList.contains("open") &&
          !sidebar.contains(e.target) &&
          e.target !== mobileMenuBtn) {
          sidebar.classList.remove("open");
          sidebarOverlay.classList.remove("visible");
        }
      });
    }


    const exportDeceasedBtn = document.getElementById("exportDeceasedList");
    if (exportDeceasedBtn) {
      exportDeceasedBtn.addEventListener("click", () => {
        const deceased = state.voters.filter(v => v.isDeceased);
        if (!deceased.length) {
          showToast(state.lang === 'mr' ? " माहिती उपलब्ध नाही" : "No data to export", "error");
          return;
        }

        const headers = ["List No", "Name (EN)", "Name (MR)", "EPIC No", "Booth", "Gender", "Mobile"];
        const csvContent = [
          headers.join(","),
          ...deceased.map(v => [
            `"${v.listNo || ""}"`,
            `"${v.voterName || ""}"`,
            `"${v.voterNameMr || ""}"`,
            `"${v.epicNo || ""}"`,
            `"${v.boothNo || ""}"`,
            `"${v.gender || ""}"`,
            `"${v.mobileNo || ""}"`
          ].join(","))
        ].join("\n");

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Deceased_Voters_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }

    // Export Duplicate List
    const exportDuplicateBtn = document.getElementById("exportDuplicateList");
    if (exportDuplicateBtn) {
      exportDuplicateBtn.addEventListener("click", () => {
        const duplicates = getDuplicateGroups();
        if (!duplicates.length) {
          showToast(state.lang === 'mr' ? "दुप्पट मतदार आढळले नाहीत" : "No duplicate voters to export", "error");
          return;
        }

        const lang = state.lang;
        const headers = [
          "Duplicate Group",
          "Name (EN)",
          "Name (MR)",
          "List No",
          "EPIC No",
          "Booth",
          "District (EN)",
          "District (MR)",
          "Taluka (EN)",
          "Taluka (MR)",
          "Caste (EN)",
          "Caste (MR)",
          "Gender (EN)",
          "Gender (MR)",
          "Mobile",
          "Address (EN)",
          "Address (MR)"
        ];

        let rows = [];
        duplicates.forEach((group, groupIdx) => {
          group.forEach((v, idx) => {
            rows.push([
              `Group ${groupIdx + 1} (${group.length} ${lang === 'mr' ? 'नोंदी' : 'Records'})`,
              v.voterName || "",
              v.voterNameMr || "",
              v.listNo || "",
              v.epicNo || "",
              v.boothNo || "",
              v.district || "",
              v.districtMr || (v.district || ""),
              v.taluka || "",
              v.talukaMr || (v.taluka || ""),
              v.caste || "",
              v.casteMr || (v.caste || ""),
              v.gender || "",
              v.genderMr || (v.gender === 'Male' ? 'पुरुष' : (v.gender === 'Female' ? 'महिला' : v.gender)),
              v.mobileNo || "",
              v.address || "",
              v.addressMr || (v.address || "")
            ]);
          });
          // Add empty row between groups
          if (groupIdx < duplicates.length - 1) {
            rows.push(Array(headers.length).fill(""));
          }
        });

        const csvContent = [
          `Duplicate Voter List - ${new Date().toLocaleDateString()}`,
          headers.join(","),
          ...rows.map(row => row.map(value => `"${`${value}`.replace(/"/g, '""')}"`).join(","))
        ].join("\r\n");

        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Duplicate_Voters_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast(lang === 'mr' ? "दुप्पट यादी एक्सपोर्ट झाली" : "Duplicate list exported successfully", "success");
      });
    }
  </script>
</body>

</html>